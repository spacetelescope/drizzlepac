<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>drizzlepac.imageObject &#8212; DrizzlePac 2.1.15 (26-May-2017) documentation</title>
    
    <link rel="stylesheet" href="../../_static/stsci_sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.1.15 (26-May-2017)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DrizzlePac 2.1.15 (26-May-2017) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/stsci_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for drizzlepac.imageObject</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A class which makes image objects for each input filename.</span>

<span class="sd">:Authors: Warren Hack</span>

<span class="sd">:License: `&lt;http://www.stsci.edu/resources/software_hardware/pyraf/LICENSE&gt;`_</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>  <span class="c1"># confidence medium</span>

<span class="kn">import</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">stwcs</span> <span class="k">import</span> <span class="n">distortion</span>

<span class="kn">from</span> <span class="nn">stsci.tools</span> <span class="k">import</span> <span class="n">fileutil</span><span class="p">,</span> <span class="n">logutil</span><span class="p">,</span> <span class="n">textutil</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">wcs_functions</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">buildmask</span>


<span class="n">IRAF_DTYPES</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;float64&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="s1">&#39;float32&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">32</span><span class="p">,</span><span class="s1">&#39;uint8&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;int16&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="s1">&#39;int32&#39;</span><span class="p">:</span><span class="mi">32</span><span class="p">}</span>


<span class="kn">from</span> <span class="nn">.version</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logutil</span><span class="o">.</span><span class="n">create_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="baseImageObject"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject">[docs]</a><span class="k">class</span> <span class="nc">baseImageObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base ImageObject which defines the primary set of methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="o">=</span> <span class="s2">&quot;SCI&quot;</span> <span class="c1"># the extension the science image is stored in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maskExt</span><span class="o">=</span><span class="s2">&quot;DQ&quot;</span> <span class="c1">#the extension with the mask image in it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errExt</span> <span class="o">=</span> <span class="s2">&quot;ERR&quot;</span>  <span class="c1"># the extension the ERR array can be found in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_file_name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">native_units</span><span class="o">=</span><span class="s1">&#39;ELECTRONS&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flatkey</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># keyword which points to flat-field reference file</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_instrument</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="o">=</span><span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputValues</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createContext</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inmemory</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># flag for all in-memory operations</span>
        <span class="c1">#this is the number of science chips to be processed in the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nextend</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1"># this is the number of chip which will be combined based on &#39;group&#39; parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nmembers</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exten</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overload  getitem to return the data and header</span>
<span class="sd">            these only work on the HDU list already in memory</span>
<span class="sd">            once the data has been zero&#39;s in self._image you should</span>
<span class="sd">            use getData or getHeader to re-read the file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">fileutil</span><span class="o">.</span><span class="n">getExtn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span><span class="n">extn</span><span class="o">=</span><span class="n">exten</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overload the comparison operator</span>
<span class="sd">            just to check the filename of the object?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">imageObject</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_isNotValid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par1</span><span class="p">,</span> <span class="n">par2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method used to determine if a value or keyword is</span>
<span class="sd">            supplied as input for instrument specific parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">invalidValues</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;None&#39;</span><span class="p">,</span><span class="s1">&#39;INDEF&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">par1</span> <span class="ow">in</span> <span class="n">invalidValues</span> <span class="ow">and</span> <span class="n">par2</span> <span class="ow">in</span> <span class="n">invalidValues</span><span class="p">)</span>

<div class="viewcode-block" id="baseImageObject.info"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return fits information on the _image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#if the file hasn&#39;t been closed yet then we can</span>
        <span class="c1">#use the fits info which looks at the extensions</span>
        <span class="c1">#if(self._isSimpleFits):</span>
        <span class="c1">#    print self._filename,&quot; is a simple fits image&quot;</span>
        <span class="c1">#else:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">info</span><span class="p">()</span></div>

<div class="viewcode-block" id="baseImageObject.close"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Close the object nicely and release all the data</span>
<span class="sd">            arrays from memory YOU CANT GET IT BACK, the pointers</span>
<span class="sd">            and data are gone so use the getData method to get</span>
<span class="sd">            the data array returned for future use. You can use</span>
<span class="sd">            putData to reattach a new data array to the imageObject.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># mcara: I think the code below is not necessary but in order to</span>
        <span class="c1">#        preserve the same functionality as the code removed below,</span>
        <span class="c1">#        I make an empty copy of the image object:</span>
        <span class="n">empty_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">:</span>
            <span class="n">empty_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
        <span class="c1"># mcara: END unnecessary code</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1">#calls fits.close()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">empty_image</span></div>

        <span class="c1">#we actuallly want to make sure that all the</span>
        <span class="c1">#data extensions have been closed and deleted</span>
        <span class="c1">#since we could have the DQ,ERR and others read in</span>
        <span class="c1">#at this point, but I&#39;d like there to be something</span>
        <span class="c1">#valid there afterwards that I can play with</span>

        <span class="c1"># mcara: REMOVED unnecessary code:</span>
        <span class="c1">#</span>
        <span class="c1"># if not self._isSimpleFits:</span>
        <span class="c1">#     for ext,hdu in enumerate(self._image):</span>
        <span class="c1">#         #use the datatype for the extension</span>
        <span class="c1">#         #dtype=self.getNumpyType(hdu.header[&quot;BITPIX&quot;])</span>
        <span class="c1">#         hdu.data = None #np.array(0,dtype=dtype)  #so we dont get io errors on stuff that wasn&#39;t read in yet</span>
        <span class="c1"># else:</span>
        <span class="c1">#     self._image.data= None # np.array(0,dtype=self.getNumpyType(self._image.header[&quot;BITPIX&quot;]))</span>

<div class="viewcode-block" id="baseImageObject.clean"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deletes intermediate products generated for this imageObject.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">clean_files</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blotImage&#39;</span><span class="p">,</span><span class="s1">&#39;crmaskImage&#39;</span><span class="p">,</span><span class="s1">&#39;finalMask&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;staticMask&#39;</span><span class="p">,</span><span class="s1">&#39;singleDrizMask&#39;</span><span class="p">,</span><span class="s1">&#39;outSky&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;outSContext&#39;</span><span class="p">,</span><span class="s1">&#39;outSWeight&#39;</span><span class="p">,</span><span class="s1">&#39;outSingle&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;outMedian&#39;</span><span class="p">,</span><span class="s1">&#39;dqmask&#39;</span><span class="p">,</span><span class="s1">&#39;tmpmask&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;skyMatchMask&#39;</span><span class="p">]</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing intermediate files for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
        <span class="c1"># We need to remove the combined products first; namely, median image</span>
        <span class="n">util</span><span class="o">.</span><span class="n">removeFileSafely</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outMedian&#39;</span><span class="p">])</span>
        <span class="c1"># Now remove chip-specific intermediate files, if any were created.</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">returnAllChips</span><span class="p">(</span><span class="n">extname</span><span class="o">=</span><span class="s1">&#39;SCI&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">clean_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">chip</span><span class="o">.</span><span class="n">outputNames</span><span class="p">:</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">removeFileSafely</span><span class="p">(</span><span class="n">chip</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="n">fname</span><span class="p">])</span></div>

<div class="viewcode-block" id="baseImageObject.getData"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getData">[docs]</a>    <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exten</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return just the data array from the specified extension</span>
<span class="sd">            fileutil is used instead of fits to account for non-</span>
<span class="sd">            FITS input images. openImage returns a fits object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exten</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;sci&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># For SCI extensions, the current file will have the data</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise, the data being requested may need to come from a</span>
            <span class="c1"># separate file, as is the case with WFPC2 DQ data.</span>
            <span class="c1">#</span>
            <span class="c1"># convert exten to &#39;sci&#39;,extver to get the DQ info for that chip</span>
            <span class="n">extn</span> <span class="o">=</span> <span class="n">exten</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">extn</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">dqfile</span>

        <span class="n">extnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interpretExten</span><span class="p">(</span><span class="n">exten</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">extnum</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                <span class="n">_image</span><span class="o">=</span><span class="n">fileutil</span><span class="o">.</span><span class="n">openImage</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">_data</span><span class="o">=</span><span class="n">fileutil</span><span class="o">.</span><span class="n">getExtn</span><span class="p">(</span><span class="n">_image</span><span class="p">,</span> <span class="n">extn</span><span class="o">=</span><span class="n">exten</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                <span class="n">_image</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">_image</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">extnum</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">extnum</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="k">return</span> <span class="n">_data</span></div>

<div class="viewcode-block" id="baseImageObject.getHeader"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getHeader">[docs]</a>    <span class="k">def</span> <span class="nf">getHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exten</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return just the specified header extension fileutil</span>
<span class="sd">            is used instead of fits to account for non-FITS</span>
<span class="sd">            input images. openImage returns a fits object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_image</span><span class="o">=</span><span class="n">fileutil</span><span class="o">.</span><span class="n">openImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_header</span><span class="o">=</span><span class="n">fileutil</span><span class="o">.</span><span class="n">getExtn</span><span class="p">(</span><span class="n">_image</span><span class="p">,</span><span class="n">extn</span><span class="o">=</span><span class="n">exten</span><span class="p">)</span><span class="o">.</span><span class="n">header</span>
        <span class="n">_image</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">_image</span>
        <span class="k">return</span> <span class="n">_header</span></div>

    <span class="k">def</span> <span class="nf">_interpretExten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exten</span><span class="p">):</span>
        <span class="c1">#check if the exten is a string or number and translate to the correct chip</span>
        <span class="n">_extnum</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">exten</span><span class="p">):</span> <span class="c1">#assume a string like &quot;sci,1&quot; has been given</span>
            <span class="n">_extensplit</span><span class="o">=</span><span class="n">exten</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">_extname</span><span class="o">=</span><span class="n">_extensplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_extver</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">_extensplit</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_extnum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">findExtNum</span><span class="p">(</span><span class="n">_extname</span><span class="p">,</span><span class="n">_extver</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#assume that a direct extnum has been given</span>
            <span class="n">_extnum</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">exten</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">_extnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no extension number found&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_extnum</span>

<div class="viewcode-block" id="baseImageObject.updateData"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.updateData">[docs]</a>    <span class="k">def</span> <span class="nf">updateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">exten</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write out updated data and header to</span>
<span class="sd">            the original input file for this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_extnum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_interpretExten</span><span class="p">(</span><span class="n">exten</span><span class="p">)</span>
        <span class="n">fimg</span> <span class="o">=</span> <span class="n">fileutil</span><span class="o">.</span><span class="n">openImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fimg</span><span class="p">[</span><span class="n">_extnum</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">fimg</span><span class="p">[</span><span class="n">_extnum</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">_extnum</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
        <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="baseImageObject.putData"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.putData">[docs]</a>    <span class="k">def</span> <span class="nf">putData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exten</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Now that we are removing the data from the object to save memory,</span>
<span class="sd">            we need something that cleanly puts the data array back into</span>
<span class="sd">            the object so that we can write out everything together  using</span>
<span class="sd">            something like fits.writeto....this method is an attempt to</span>
<span class="sd">            make sure that when you add an array back to the .data section</span>
<span class="sd">            of the hdu it still matches the header information for that</span>
<span class="sd">            section ( ie. update the bitpix to reflect the datatype of the</span>
<span class="sd">            array you are adding). The other header stuff is up to you to verify.</span>

<span class="sd">            Data should be the data array exten is where you want to stick it,</span>
<span class="sd">            either extension number or a string like &#39;sci,1&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No data supplied&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extnum</span> <span class="o">=</span> <span class="n">_interpretExten</span><span class="p">(</span><span class="n">exten</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">extnum</span><span class="p">]</span>
            <span class="c1"># update the bitpix to the current datatype, this aint fancy and</span>
            <span class="c1"># ignores bscale</span>
            <span class="n">ext</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BITPIX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">IRAF_DTYPES</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="n">ext</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span></div>

<div class="viewcode-block" id="baseImageObject.getAllData"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getAllData">[docs]</a>    <span class="k">def</span> <span class="nf">getAllData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">extname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This function is meant to make it easier to attach ALL the data</span>
<span class="sd">            extensions of the image object so that we can write out copies of</span>
<span class="sd">            the original image nicer.</span>

<span class="sd">            If no extname is given, the it retrieves all data from the original</span>
<span class="sd">            file and attaches it. Otherwise, give the name of the extensions</span>
<span class="sd">            you want and all of those will be restored.</span>

<span class="sd">            Ok, I added another option. If you want to get all the data</span>
<span class="sd">            extensions EXCEPT a particular one, leave extname=NONE and</span>
<span class="sd">            set exclude=EXTNAME. This is helpfull cause you might not know</span>
<span class="sd">            all the extnames the image has, this will find out and exclude</span>
<span class="sd">            the one you do not want overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findExtnames</span><span class="p">(</span><span class="n">extname</span><span class="o">=</span><span class="n">extname</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextend</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;_extension&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="s2">&quot;IMAGE&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_extension</span><span class="p">:</span>
                <span class="n">extver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;extver&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extname</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">extver</span><span class="p">]</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extname</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extver</span><span class="p">))</span></div>

<div class="viewcode-block" id="baseImageObject.returnAllChips"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.returnAllChips">[docs]</a>    <span class="k">def</span> <span class="nf">returnAllChips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">extname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a list containing all the chips which match the</span>
<span class="sd">            extname given minus those specified for exclusion (if any).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findExtnames</span><span class="p">(</span><span class="n">extname</span><span class="o">=</span><span class="n">extname</span><span class="p">,</span><span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
        <span class="n">chiplist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextend</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;extver&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="n">extver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;extver&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extver</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;_extension&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="s2">&quot;IMAGE&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_extension</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extname</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">extver</span><span class="p">]</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span>
                    <span class="n">chiplist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">chiplist</span></div>

    <span class="k">def</span> <span class="nf">_findExtnames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method builds a list of all extensions which have &#39;EXTNAME&#39;==extname</span>
<span class="sd">            and do not include any extensions with &#39;EXTNAME&#39;==exclude, if any are</span>
<span class="sd">            specified for exclusion at all.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#make a list of the available extension names for the object</span>
        <span class="n">extensions</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">extname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extname</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span> <span class="n">extname</span><span class="o">=</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">extn</span> <span class="ow">in</span> <span class="n">extname</span><span class="p">:</span>
                <span class="n">extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extn</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
        <span class="c1">#restore all the extensions data from the original file, be careful here</span>
        <span class="c1">#if you&#39;ve altered data in memory you want to keep!</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_nextend</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s1">&#39;_extension&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="s2">&quot;IMAGE&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">_extension</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                        <span class="n">extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extname</span><span class="p">)</span>
        <span class="c1">#remove this extension from the list</span>
        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exclude</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">exclude</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                <span class="n">newExt</span><span class="o">=</span><span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="n">exclude</span><span class="p">:</span>
                        <span class="n">newExt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">extensions</span><span class="o">=</span><span class="n">newExt</span>
            <span class="k">del</span> <span class="n">newExt</span>
        <span class="k">return</span> <span class="n">extensions</span>

<div class="viewcode-block" id="baseImageObject.findExtNum"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.findExtNum">[docs]</a>    <span class="k">def</span> <span class="nf">findExtNum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extver</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the extension number of the give extname and extver.&quot;&quot;&quot;</span>

        <span class="n">extnum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">extname</span> <span class="o">=</span> <span class="n">extname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSimpleFits</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span><span class="s1">&#39;_extension&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;IMAGE&#39;</span> <span class="ow">in</span> <span class="n">ext</span><span class="o">.</span><span class="n">_extension</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">extname</span> <span class="o">==</span> <span class="n">extname</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ext</span><span class="o">.</span><span class="n">extver</span> <span class="o">==</span> <span class="n">extver</span><span class="p">)):</span>
                    <span class="n">extnum</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">extnum</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Image is simple fits&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">extnum</span></div>

    <span class="k">def</span> <span class="nf">_assignRootname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assign a unique rootname for the image based in the expname.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">extname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">extver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTVER&quot;</span><span class="p">]</span>
        <span class="n">expname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># record extension-based name to reflect what extension a mask file corresponds to</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">rootname</span><span class="o">=</span><span class="n">expname</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">extname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">extver</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">sciname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">+</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="n">extname</span> <span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">extver</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;]&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">dqrootname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">extname</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">extver</span><span class="p">)</span>
        <span class="c1"># Needed to keep EXPNAMEs associated properly (1 EXPNAME for all chips)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">_expname</span><span class="o">=</span><span class="n">expname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">_chip</span> <span class="o">=</span><span class="n">chip</span>


    <span class="k">def</span> <span class="nf">_setOutputNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rootname</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_drz&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define the default output filenames for drizzle products,</span>
<span class="sd">            these are based on the original rootname of the image</span>
<span class="sd">            filename should be just 1 filename, so call this in a loop</span>
<span class="sd">            for chip names contained inside a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Define FITS output filenames for intermediate products</span>

        <span class="c1"># Build names based on final DRIZZLE output name</span>
        <span class="c1"># where &#39;output&#39; normally would have been created</span>
        <span class="c1">#   by &#39;process_input()&#39;</span>
        <span class="c1">#</span>
        <span class="n">outFinal</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s1">&#39;.fits&#39;</span>
        <span class="n">outSci</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s1">&#39;_sci.fits&#39;</span>
        <span class="n">outWeight</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s1">&#39;_wht.fits&#39;</span>
        <span class="n">outContext</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="n">suffix</span><span class="o">+</span><span class="s1">&#39;_ctx.fits&#39;</span>
        <span class="n">outMedian</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="s1">&#39;_med.fits&#39;</span>

        <span class="c1"># Build names based on input name</span>
        <span class="n">origFilename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="s1">&#39;_OrIg.fits&#39;</span><span class="p">)</span>
        <span class="n">outSky</span> <span class="o">=</span> <span class="n">rootname</span> <span class="o">+</span> <span class="s1">&#39;_sky.fits&#39;</span>
        <span class="n">outSingle</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="s1">&#39;_single_sci.fits&#39;</span>
        <span class="n">outSWeight</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="s1">&#39;_single_wht.fits&#39;</span>
        <span class="n">crCorImage</span> <span class="o">=</span> <span class="n">rootname</span><span class="o">+</span><span class="s1">&#39;_crclean.fits&#39;</span>

        <span class="c1"># Build outputNames dictionary</span>
        <span class="n">fnames</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;origFilename&#39;</span><span class="p">:</span><span class="n">origFilename</span><span class="p">,</span>
            <span class="s1">&#39;outFinal&#39;</span><span class="p">:</span><span class="n">outFinal</span><span class="p">,</span>
            <span class="s1">&#39;outMedian&#39;</span><span class="p">:</span><span class="n">outMedian</span><span class="p">,</span>
            <span class="s1">&#39;outSci&#39;</span><span class="p">:</span><span class="n">outSci</span><span class="p">,</span>
            <span class="s1">&#39;outWeight&#39;</span><span class="p">:</span><span class="n">outWeight</span><span class="p">,</span>
            <span class="s1">&#39;outContext&#39;</span><span class="p">:</span><span class="n">outContext</span><span class="p">,</span>
            <span class="s1">&#39;outSingle&#39;</span><span class="p">:</span><span class="n">outSingle</span><span class="p">,</span>
            <span class="s1">&#39;outSWeight&#39;</span><span class="p">:</span><span class="n">outSWeight</span><span class="p">,</span>
            <span class="s1">&#39;outSContext&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;outSky&#39;</span><span class="p">:</span><span class="n">outSky</span><span class="p">,</span>
            <span class="s1">&#39;crcorImage&#39;</span><span class="p">:</span><span class="n">crCorImage</span><span class="p">,</span>
            <span class="s1">&#39;ivmFile&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>


        <span class="k">return</span> <span class="n">fnames</span>

    <span class="k">def</span> <span class="nf">_setChipOutputNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rootname</span><span class="p">,</span><span class="n">chip</span><span class="p">):</span>
        <span class="n">blotImage</span> <span class="o">=</span> <span class="n">rootname</span> <span class="o">+</span> <span class="s1">&#39;_blt.fits&#39;</span>
        <span class="n">crmaskImage</span> <span class="o">=</span> <span class="n">rootname</span> <span class="o">+</span> <span class="s1">&#39;_crmask.fits&#39;</span>

        <span class="c1"># Start with global names</span>
        <span class="n">fnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span>

        <span class="c1"># Now add chip-specific entries</span>
        <span class="n">fnames</span><span class="p">[</span><span class="s1">&#39;blotImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blotImage</span>
        <span class="n">fnames</span><span class="p">[</span><span class="s1">&#39;crmaskImage&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crmaskImage</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
        <span class="c1"># Define mask names as additional entries into outputNames dictionary</span>
        <span class="n">fnames</span><span class="p">[</span><span class="s1">&#39;finalMask&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">dqrootname</span><span class="o">+</span><span class="s1">&#39;_final_mask.fits&#39;</span> <span class="c1"># used by final_drizzle</span>
        <span class="n">fnames</span><span class="p">[</span><span class="s1">&#39;singleDrizMask&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fnames</span><span class="p">[</span><span class="s1">&#39;finalMask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;final&#39;</span><span class="p">,</span><span class="s1">&#39;single&#39;</span><span class="p">)</span>
        <span class="n">fnames</span><span class="p">[</span><span class="s1">&#39;staticMask&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>

        <span class="c1"># Add the following entries for use in creating outputImage object</span>
        <span class="n">fnames</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">sciname</span>
        <span class="k">return</span> <span class="n">fnames</span>

<span class="c1">##############################################################</span>
<span class="c1">#</span>
<span class="c1"># Methods related to managing virtual intermediate output products</span>
<span class="c1"># as opposed to writing them out as files on disk</span>
<span class="c1">#</span>
<span class="c1">##############################################################</span>
    <span class="k">def</span> <span class="nf">_initVirtualOutputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets up the structure to hold all the output data arrays for</span>
<span class="sd">            this image in memory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtualOutputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtualOutputs</span><span class="p">[</span><span class="n">product</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="baseImageObject.saveVirtualOutputs"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.saveVirtualOutputs">[docs]</a>    <span class="k">def</span> <span class="nf">saveVirtualOutputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">outdict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assign in-memory versions of generated products for this imageObject</span>
<span class="sd">            based on dictionary &#39;outdict&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inmemory</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">outname</span> <span class="ow">in</span> <span class="n">outdict</span><span class="p">:</span>
<span class="c1">#           log.info(&#39;saveVirtualOutputs: writing key &#39;+outname+&#39; for id: &#39;+str(id(self)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">virtualOutputs</span><span class="p">[</span><span class="n">outname</span><span class="p">]</span> <span class="o">=</span> <span class="n">outdict</span><span class="p">[</span><span class="n">outname</span><span class="p">]</span></div>

<div class="viewcode-block" id="baseImageObject.getOutputName"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getOutputName">[docs]</a>    <span class="k">def</span> <span class="nf">getOutputName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the name of the file or PyFITS object associated with that</span>
<span class="sd">            name, depending on the setting of self.inmemory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inmemory</span><span class="p">:</span> <span class="c1"># if inmemory was turned on...</span>
            <span class="c1"># return virtualOutput object saved with that name</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtualOutputs</span><span class="p">[</span><span class="n">val</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">val</span></div>

<span class="c1">##############################################################</span>
<span class="c1"># Methods for managing output values associated with this input</span>
<span class="c1">##############################################################</span>
<div class="viewcode-block" id="baseImageObject.updateOutputValues"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.updateOutputValues">[docs]</a>    <span class="k">def</span> <span class="nf">updateOutputValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">output_wcs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Copy info from output WCSObject into outputnames for each chip</span>
<span class="sd">            for use in creating outputimage object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">outputvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputValues</span>

        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outFinal&#39;</span><span class="p">]</span>
        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;outnx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">_naxis1</span>
        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;outny&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">_naxis2</span>
        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;texptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">_exptime</span>
        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;texpstart&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">_expstart</span>
        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;texpend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">_expend</span>
        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;nimages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">nimages</span>

        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pscale</span> <span class="c1">#/ self._image[self.scienceExt,1].wcs.pscale</span>
        <span class="n">outputvals</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exptime</span>

        <span class="n">outnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span>
        <span class="n">outnames</span><span class="p">[</span><span class="s1">&#39;outMedian&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outMedian&#39;</span><span class="p">]</span>
        <span class="n">outnames</span><span class="p">[</span><span class="s1">&#39;outFinal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outFinal&#39;</span><span class="p">]</span>
        <span class="n">outnames</span><span class="p">[</span><span class="s1">&#39;outSci&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outSci&#39;</span><span class="p">]</span>
        <span class="n">outnames</span><span class="p">[</span><span class="s1">&#39;outWeight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outWeight&#39;</span><span class="p">]</span>
        <span class="n">outnames</span><span class="p">[</span><span class="s1">&#39;outContext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_wcs</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outContext&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="baseImageObject.updateContextImage"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.updateContextImage">[docs]</a>    <span class="k">def</span> <span class="nf">updateContextImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contextpar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the name of the context image to None if parameter `context` == False.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createContext</span> <span class="o">=</span> <span class="n">contextpar</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">contextpar</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No context image will be created for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;outContext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="baseImageObject.find_DQ_extension"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.find_DQ_extension">[docs]</a>    <span class="k">def</span> <span class="nf">find_DQ_extension</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the suffix for the data quality extension and the name of the</span>
<span class="sd">        file which that DQ extension should be read from.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dqfile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dq_suffix</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maskExt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">:</span>
                <span class="c1"># Look for DQ extension in input file</span>
                <span class="k">if</span> <span class="s1">&#39;extname&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;extname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">maskExt</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">dqfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span>
                    <span class="n">dq_suffix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maskExt</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">dqfile</span><span class="p">,</span><span class="n">dq_suffix</span></div>


<div class="viewcode-block" id="baseImageObject.getKeywordList"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getKeywordList">[docs]</a>    <span class="k">def</span> <span class="nf">getKeywordList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return lists of all attribute values for all active chips in the</span>
<span class="sd">        imageObject.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kwlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">group_member</span><span class="p">:</span>
                <span class="n">kwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">kw</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">kwlist</span></div>

<div class="viewcode-block" id="baseImageObject.getGain"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getGain">[docs]</a>    <span class="k">def</span> <span class="nf">getGain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exten</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">exten</span><span class="p">]</span><span class="o">.</span><span class="n">_gain</span></div>

<div class="viewcode-block" id="baseImageObject.getflat"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getflat">[docs]</a>    <span class="k">def</span> <span class="nf">getflat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for retrieving a detector&#39;s flat field.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        flat: array</span>
<span class="sd">            This method will return an array the same shape as the image in</span>
<span class="sd">            **units of electrons**.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span> <span class="n">chip</span><span class="p">]</span>
        <span class="n">exten</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span> <span class="n">chip</span><span class="p">)</span>
        <span class="c1"># The keyword for ACS flat fields in the primary header of the flt</span>
        <span class="c1"># file is pfltfile.  This flat file is already in the required</span>
        <span class="c1"># units of electrons.</span>

        <span class="c1"># The use of fileutil.osfn interprets any environment variable, such as jref$,</span>
        <span class="c1"># used in the specification of the reference filename</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">fileutil</span><span class="o">.</span><span class="n">osfn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="s2">&quot;PRIMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flatkey</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">fileutil</span><span class="o">.</span><span class="n">openImage</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">hdu</span> <span class="o">=</span> <span class="n">fileutil</span><span class="o">.</span><span class="n">getExtn</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="n">extn</span><span class="o">=</span><span class="n">exten</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">_ltv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_ltv2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_size2</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">_ltv2</span>
            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">_ltv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_ltv1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_size1</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">_ltv1</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_ltv2</span><span class="p">:</span><span class="n">_size2</span><span class="p">,</span> <span class="n">_ltv1</span><span class="p">:</span><span class="n">_size1</span><span class="p">]</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_dtype</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot find file </span><span class="si">%s</span><span class="s2">.</span><span class="se">\n</span><span class="s2">    Treating flatfield &quot;</span>
                        <span class="s2">&quot;constant value of &#39;1&#39;.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">flat</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">flat</span></div>

<div class="viewcode-block" id="baseImageObject.getReadNoiseImage"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getReadNoiseImage">[docs]</a>    <span class="k">def</span> <span class="nf">getReadNoiseImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        Method for returning the readnoise image of a detector</span>
<span class="sd">        (in electrons).</span>

<span class="sd">        The method will return an array of the same shape as the image.</span>

<span class="sd">        :units: electrons</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_dtype</span><span class="p">)</span> <span class="o">*</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">_rdnoise</span></div>

<div class="viewcode-block" id="baseImageObject.getexptimeimg"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getexptimeimg">[docs]</a>    <span class="k">def</span> <span class="nf">getexptimeimg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        Return an array representing the exposure time per pixel for the detector.</span>
<span class="sd">        This method will be overloaded for IR detectors which have their own</span>
<span class="sd">        EXP arrays, namely, WFC3/IR and NICMOS images.</span>

<span class="sd">        :units:</span>
<span class="sd">          None</span>

<span class="sd">        Returns</span>
<span class="sd">        =======</span>
<span class="sd">        exptimeimg : numpy array</span>
<span class="sd">            The method will return an array of the same shape as the image.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">_wtscl_par</span> <span class="o">==</span> <span class="s1">&#39;expsq&#39;</span><span class="p">:</span>
            <span class="n">wtscl</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">_exptime</span><span class="o">*</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">_exptime</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wtscl</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">_exptime</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_dtype</span><span class="p">)</span><span class="o">*</span><span class="n">wtscl</span></div>

<div class="viewcode-block" id="baseImageObject.getdarkimg"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getdarkimg">[docs]</a>    <span class="k">def</span> <span class="nf">getdarkimg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        Return an array representing the dark image for the detector.</span>

<span class="sd">        The method will return an array of the same shape as the image.</span>

<span class="sd">        :units: electrons</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_dtype</span><span class="p">)</span><span class="o">*</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">darkcurrent</span></div>

<div class="viewcode-block" id="baseImageObject.getskyimg"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getskyimg">[docs]</a>    <span class="k">def</span> <span class="nf">getskyimg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        Return an array representing the sky image for the detector.  The value</span>
<span class="sd">        of the sky is what would actually be subtracted from the exposure by</span>
<span class="sd">        the skysub step.</span>

<span class="sd">        :units: electrons</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">image_dtype</span><span class="p">)</span><span class="o">*</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">subtractedSky</span></div>

<div class="viewcode-block" id="baseImageObject.getdarkcurrent"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getdarkcurrent">[docs]</a>    <span class="k">def</span> <span class="nf">getdarkcurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Notes</span>
<span class="sd">        =====</span>
<span class="sd">        Return the dark current for the detector.  This value</span>
<span class="sd">        will be contained within an instrument specific keyword.</span>
<span class="sd">        The value in the image header will be converted to units</span>
<span class="sd">        of electrons.</span>

<span class="sd">        :units: electrons</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<span class="c1">#the following two functions are basically doing the same thing,</span>
<span class="c1">#how are they used differently in the code?</span>
<div class="viewcode-block" id="baseImageObject.getExtensions"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getExtensions">[docs]</a>    <span class="k">def</span> <span class="nf">getExtensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">extname</span><span class="o">=</span><span class="s1">&#39;SCI&#39;</span><span class="p">,</span><span class="n">section</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return the list of EXTVER values for extensions with name specified in extname.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">numext</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">section</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">:</span>
               <span class="k">if</span> <span class="s1">&#39;extname&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;extname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">extname</span><span class="p">:</span>
                    <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;extver&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">section</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">section</span> <span class="o">=</span> <span class="p">[</span><span class="n">section</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">section</span></div>



    <span class="k">def</span> <span class="nf">_countEXT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">extname</span><span class="o">=</span><span class="s2">&quot;SCI&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Count the number of extensions in the file</span>
<span class="sd">            with the given name (EXTNAME).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">count</span><span class="o">=</span><span class="mi">0</span> <span class="c1">#simple fits image</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTEND&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">hdu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hduExtname</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;EXTNAME&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extnum</span><span class="o">=</span><span class="n">i</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extname</span><span class="o">=</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span>
                        <span class="n">hduExtname</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="s1">&#39;EXTVER&#39;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extver</span><span class="o">=</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTVER&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extver</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="p">((</span><span class="n">extname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> \
                            <span class="p">(</span><span class="n">hduExtname</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">extname</span><span class="p">)))</span> \
                            <span class="ow">or</span> <span class="n">extname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>

<div class="viewcode-block" id="baseImageObject.getNumpyType"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getNumpyType">[docs]</a>    <span class="k">def</span> <span class="nf">getNumpyType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">irafType</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the corresponding numpy data type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">iraf</span><span class="o">=</span><span class="p">{</span><span class="o">-</span><span class="mi">64</span><span class="p">:</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">32</span><span class="p">:</span><span class="s1">&#39;float32&#39;</span><span class="p">,</span><span class="mi">8</span><span class="p">:</span><span class="s1">&#39;uint8&#39;</span><span class="p">,</span><span class="mi">16</span><span class="p">:</span><span class="s1">&#39;int16&#39;</span><span class="p">,</span><span class="mi">32</span><span class="p">:</span><span class="s1">&#39;int32&#39;</span><span class="p">,</span><span class="mi">64</span><span class="p">:</span><span class="s1">&#39;int64&#39;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">iraf</span><span class="p">[</span><span class="n">irafType</span><span class="p">]</span></div>

<div class="viewcode-block" id="baseImageObject.buildMask"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.buildMask">[docs]</a>    <span class="k">def</span> <span class="nf">buildMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chip</span><span class="p">,</span><span class="n">bits</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build masks as specified in the user parameters found in the</span>
<span class="sd">        configObj object.</span>

<span class="sd">        We should overload this function in the instrument specific</span>
<span class="sd">        implementations so that we can add other stuff to the badpixel</span>
<span class="sd">        mask? Like vignetting areas and chip boundries in nicmos which</span>
<span class="sd">        are camera dependent? these are not defined in the DQ masks, but</span>
<span class="sd">        should be masked out to get the best results in multidrizzle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dqarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">exten</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">maskExt</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
        <span class="n">dqmask</span> <span class="o">=</span> <span class="n">buildmask</span><span class="o">.</span><span class="n">buildMask</span><span class="p">(</span><span class="n">dqarr</span><span class="p">,</span><span class="n">bits</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
            <span class="n">phdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dqmask</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">maskExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">dqmask_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">dqrootname</span><span class="o">+</span><span class="s1">&#39;_dqmask.fits&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing out DQ/weight mask: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">dqmask_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dqmask_name</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dqmask_name</span><span class="p">)</span>
            <span class="n">phdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">dqmask_name</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">phdu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">dqmaskname</span> <span class="o">=</span> <span class="n">dqmask_name</span>
            <span class="c1"># record the name of this mask file that was created for later</span>
            <span class="c1"># removal by the &#39;clean()&#39; method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;dqmask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dqmask_name</span>
        <span class="k">del</span> <span class="n">dqarr</span>
        <span class="k">return</span> <span class="n">dqmask</span></div>

<div class="viewcode-block" id="baseImageObject.buildEXPmask"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.buildEXPmask">[docs]</a>    <span class="k">def</span> <span class="nf">buildEXPmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">dqarr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Builds a weight mask from an input DQ array and the exposure time</span>
<span class="sd">        per pixel for this chip.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying EXPTIME weighting to DQ mask for chip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                 <span class="n">chip</span><span class="p">)</span>
        <span class="c1">#exparr = self.getexptimeimg(chip)</span>
        <span class="n">exparr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span><span class="o">.</span><span class="n">_exptime</span>
        <span class="n">expmask</span> <span class="o">=</span> <span class="n">exparr</span><span class="o">*</span><span class="n">dqarr</span>

        <span class="k">return</span> <span class="n">expmask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="baseImageObject.buildIVMmask"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.buildIVMmask">[docs]</a>    <span class="k">def</span> <span class="nf">buildIVMmask</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span><span class="n">chip</span><span class="p">,</span> <span class="n">dqarr</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Builds a weight mask from an input DQ array and either an IVM array</span>
<span class="sd">        provided by the user or a self-generated IVM array derived from the</span>
<span class="sd">        flat-field reference file associated with the input image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
        <span class="n">ivmname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;ivmFile&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ivmname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying user supplied IVM files for chip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chip</span><span class="p">)</span>
            <span class="c1">#Parse the input file name to get the extension we are working on</span>
            <span class="n">extn</span> <span class="o">=</span> <span class="s2">&quot;IVM,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>

            <span class="c1">#Open the mask image for updating and the IVM image</span>
            <span class="n">ivm</span> <span class="o">=</span>  <span class="n">fileutil</span><span class="o">.</span><span class="n">openImage</span><span class="p">(</span><span class="n">ivmname</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ivmfile</span> <span class="o">=</span> <span class="n">fileutil</span><span class="o">.</span><span class="n">getExtn</span><span class="p">(</span><span class="n">ivm</span><span class="p">,</span> <span class="n">extn</span><span class="p">)</span>

            <span class="c1"># Multiply the IVM file by the input mask in place.</span>
            <span class="n">ivmarr</span> <span class="o">=</span> <span class="n">ivmfile</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">dqarr</span>

            <span class="n">ivm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Automatically creating IVM files for chip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">chip</span><span class="p">)</span>
            <span class="c1"># If no IVM files were provided by the user we will</span>
            <span class="c1"># need to automatically generate them based upon</span>
            <span class="c1"># instrument specific information.</span>

            <span class="n">flat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getflat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>
            <span class="n">RN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getReadNoiseImage</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>
            <span class="n">darkimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdarkimg</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>
            <span class="n">skyimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getskyimg</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>

            <span class="c1">#exptime = self.getexptimeimg(chip)</span>
            <span class="c1">#exptime = sci_chip._exptime</span>
            <span class="c1">#ivm = (flat*exptime)**2/(darkimg+(skyimg*flat)+RN**2)</span>
            <span class="n">ivm</span> <span class="o">=</span> <span class="p">(</span><span class="n">flat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">darkimg</span><span class="o">+</span><span class="p">(</span><span class="n">skyimg</span><span class="o">*</span><span class="n">flat</span><span class="p">)</span><span class="o">+</span><span class="n">RN</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

           <span class="c1"># Multiply the IVM file by the input mask in place.</span>
            <span class="n">ivmarr</span> <span class="o">=</span> <span class="n">ivm</span> <span class="o">*</span> <span class="n">dqarr</span>

        <span class="c1"># Update &#39;wt_scl&#39; parameter to match use of IVM file</span>
        <span class="n">sci_chip</span><span class="o">.</span><span class="n">_wtscl</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">_exptime</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">pow</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="c1">#sci_chip._wtscl = 1.0/pow(scale,4)</span>

        <span class="k">return</span> <span class="n">ivmarr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="baseImageObject.buildERRmask"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.buildERRmask">[docs]</a>    <span class="k">def</span> <span class="nf">buildERRmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chip</span><span class="p">,</span><span class="n">dqarr</span><span class="p">,</span><span class="n">scale</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds a weight mask from an input DQ array and an ERR array</span>
<span class="sd">        associated with the input image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>

        <span class="c1"># Set default value in case of error, or lack of ERR array</span>
        <span class="n">errmask</span> <span class="o">=</span> <span class="n">dqarr</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errExt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Attempt to open the ERR image.</span>
                <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">exten</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">errExt</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>

                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying ERR weighting to DQ mask for chip </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                         <span class="n">chip</span><span class="p">)</span>

                <span class="c1"># Multiply the scaled ERR file by the input mask in place.</span>
                <span class="c1">#exptime = self.getexptimeimg(chip)</span>
                <span class="n">exptime</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">_exptime</span>
                <span class="n">errmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">exptime</span><span class="o">/</span><span class="n">err</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dqarr</span>

                <span class="c1"># Update &#39;wt_scl&#39; parameter to match use of IVM file</span>
                <span class="c1">#sci_chip._wtscl = pow(sci_chip._exptime,2)/pow(scale,4)</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_wtscl</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="nb">pow</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>

                <span class="k">del</span> <span class="n">err</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># We cannot find an &#39;ERR&#39; extension and the data isn&#39;t WFPC2.</span>
                <span class="c1"># Print a generic warning message and continue on with the</span>
                <span class="c1"># final drizzle step.</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span>
                    <span class="s1">&#39;WARNING: No ERR weighting will be applied to the mask &#39;</span>
                    <span class="s1">&#39;used in the final drizzle step!  Weighting will be only &#39;</span>
                    <span class="s1">&#39;by exposure time.</span><span class="se">\n\n</span><span class="s1">The data provided as input does not &#39;</span>
                    <span class="s1">&#39;contain an ERR extension&#39;</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Continue with final drizzle step...&#39;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we were unable to find an &#39;ERR&#39; extension to apply, one</span>
            <span class="c1"># possible reason was that the input was a &#39;standard&#39; WFPC2 data</span>
            <span class="c1"># file that does not actually contain an error array.  Test for</span>
            <span class="c1"># this condition and issue a Warning to the user and continue on to</span>
            <span class="c1"># the final drizzle.</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: No ERR weighting will be applied to the mask used &quot;</span>
                <span class="s2">&quot;in the final drizzle step!  Weighting will be only by &quot;</span>
                <span class="s2">&quot;exposure time.</span><span class="se">\n\n</span><span class="s2">The WFPC2 data provided as input does not &quot;</span>
                <span class="s2">&quot;contain ERR arrays.  WFPC2 data is not supported by this &quot;</span>
                <span class="s2">&quot;weighting type.</span><span class="se">\n\n</span><span class="s2">A workaround would be to create inverse &quot;</span>
                <span class="s2">&quot;variance maps and use &#39;IVM&#39; as the final_wht_type.  See the &quot;</span>
                <span class="s2">&quot;HELP file for more details on using inverse variance maps.&quot;</span><span class="p">),</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Continue with final drizzle step...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">errmask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span></div>

<div class="viewcode-block" id="baseImageObject.updateIVMName"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.updateIVMName">[docs]</a>    <span class="k">def</span> <span class="nf">updateIVMName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ivmname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update outputNames for image with user-supplied IVM filename.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="p">[</span><span class="s1">&#39;ivmFile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivmname</span></div>

<div class="viewcode-block" id="baseImageObject.set_mt_wcs"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.set_mt_wcs">[docs]</a>    <span class="k">def</span> <span class="nf">set_mt_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reset the WCS for this image based on the WCS information from</span>
<span class="sd">            another imageObject.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
            <span class="n">ref_chip</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
            <span class="c1"># Do we want to keep track of original WCS or not? No reason now...</span>
            <span class="n">sci_chip</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">ref_chip</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="baseImageObject.set_wtscl"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.set_wtscl">[docs]</a>    <span class="k">def</span> <span class="nf">set_wtscl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">wtscl_par</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sets the value of the wt_scl parameter as needed for drizzling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>

        <span class="n">exptime</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#sci_chip._exptime</span>
        <span class="n">_parval</span> <span class="o">=</span> <span class="s1">&#39;unity&#39;</span>
        <span class="k">if</span> <span class="n">wtscl_par</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">wtscl_par</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">wtscl_par</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="c1"># String passed in as value, check for &#39;exptime&#39; or &#39;expsq&#39;</span>
                    <span class="n">_wtscl_float</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_wtscl_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wtscl_par</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">_wtscl_float</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">_wtscl_float</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">_wtscl</span> <span class="o">=</span> <span class="n">_wtscl_float</span>
                    <span class="k">elif</span> <span class="n">wtscl_par</span> <span class="o">==</span> <span class="s1">&#39;expsq&#39;</span><span class="p">:</span>
                        <span class="n">_wtscl</span> <span class="o">=</span> <span class="n">exptime</span><span class="o">*</span><span class="n">exptime</span>
                        <span class="n">_parval</span> <span class="o">=</span> <span class="s1">&#39;expsq&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Default to the case of &#39;exptime&#39;, if</span>
                        <span class="c1">#   not explicitly specified as &#39;expsq&#39;</span>
                        <span class="n">_wtscl</span> <span class="o">=</span> <span class="n">exptime</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># int value passed in as a string, convert to float</span>
                    <span class="n">_wtscl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wtscl_par</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We have a non-string value passed in...</span>
                <span class="n">_wtscl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wtscl_par</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Default case: wt_scl = exptime</span>
            <span class="n">_wtscl</span> <span class="o">=</span> <span class="n">exptime</span>

        <span class="n">sci_chip</span><span class="o">.</span><span class="n">_wtscl_par</span> <span class="o">=</span> <span class="n">_parval</span>
        <span class="n">sci_chip</span><span class="o">.</span><span class="n">_wtscl</span> <span class="o">=</span> <span class="n">_wtscl</span></div>

<div class="viewcode-block" id="baseImageObject.set_units"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.set_units">[docs]</a>    <span class="k">def</span> <span class="nf">set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Record the units for this image, both BUNITS from header and</span>
<span class="sd">            in_units as needed internally. This method will be defined</span>
<span class="sd">            specifically for each instrument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="baseImageObject.getInstrParameter"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.baseImageObject.getInstrParameter">[docs]</a>    <span class="k">def</span> <span class="nf">getInstrParameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method gets a instrument parameter from a</span>
<span class="sd">            pair of task parameters: a value, and a header keyword.</span>

<span class="sd">            The default behavior is:</span>
<span class="sd">              - if the value and header keyword are given, raise an exception.</span>
<span class="sd">              - if the value is given, use it.</span>
<span class="sd">              - if the value is blank and the header keyword is given, use</span>
<span class="sd">                the header keyword.</span>
<span class="sd">              - if both are blank, or if the header keyword is not</span>
<span class="sd">                found, return None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;INDEF&#39;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">and</span> <span class="p">(</span><span class="n">keyword</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">keyword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">exceptionMessage</span> <span class="o">=</span> <span class="s2">&quot;ERROR: Your input is ambiguous!  Please specify either a value or a keyword.</span><span class="se">\n</span><span class="s2">  You specifed both &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">exceptionMessage</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_averageFromList</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">keyword</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">keyword</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_averageFromHeader</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_averageFromHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Averages out values taken from header. The keywords where</span>
<span class="sd">            to read values from are passed as a comma-separated list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_list</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">_kw</span> <span class="ow">in</span> <span class="n">keyword</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_kw</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
                <span class="n">_list</span> <span class="o">=</span> <span class="n">_list</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="n">_kw</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_averageFromList</span><span class="p">(</span><span class="n">_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_averageFromList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Averages out values passed as a comma-separated</span>
<span class="sd">            list, disregarding the zero-valued entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_result</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">_param</span> <span class="ow">in</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_param</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">_param</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">_result</span> <span class="o">=</span> <span class="n">_result</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">_param</span><span class="p">)</span>
                <span class="n">_count</span>  <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">_count</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_result</span> <span class="o">=</span> <span class="n">_result</span> <span class="o">/</span> <span class="n">_count</span>
        <span class="k">return</span> <span class="n">_result</span></div>

<div class="viewcode-block" id="imageObject"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.imageObject">[docs]</a><span class="k">class</span> <span class="nc">imageObject</span><span class="p">(</span><span class="n">baseImageObject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This returns an imageObject that contains all the</span>
<span class="sd">        necessary information to run the image file through</span>
<span class="sd">        any multidrizzle function. It is essentially a</span>
<span class="sd">        PyFits object with extra attributes.</span>

<span class="sd">        There will be generic keywords which are good for</span>
<span class="sd">        the entire image file, and some that might pertain</span>
<span class="sd">        only to the specific chip.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">inmemory</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">baseImageObject</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1">#filutil open returns a fits object</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">=</span><span class="n">fileutil</span><span class="o">.</span><span class="n">openImage</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Unable to open file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c1">#populate the global attributes which are good for all the chips in the file</span>
        <span class="c1">#self._rootname=self._image[&#39;PRIMARY&#39;].header[&quot;ROOTNAME&quot;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span><span class="o">=</span><span class="n">fileutil</span><span class="o">.</span><span class="n">buildNewRootname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_setOutputNames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span><span class="p">)</span>

        <span class="c1"># flag to indicate whether or not to write out intermediate products</span>
        <span class="c1"># to disk (default) or keep everything in memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inmemory</span> <span class="o">=</span> <span class="n">inmemory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initVirtualOutputs</span><span class="p">()</span>

        <span class="c1">#self._exptime=self._image[&quot;PRIMARY&quot;].header[&quot;EXPTIME&quot;]</span>
        <span class="c1">#exptime should be set in the image subclass code since it&#39;s kept in different places</span>
<span class="c1">#        if(self._exptime == 0):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exptime</span> <span class="o">=</span><span class="mf">1.</span> <span class="c1">#to avoid divide by zero</span>
 <span class="c1">#           print &quot;Setting exposure time to 1. to avoid div/0!&quot;</span>

        <span class="c1">#this is the number of science chips to be processed in the file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_countEXT</span><span class="p">(</span><span class="n">extname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">proc_unit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#self._nextend=self._image[&quot;PRIMARY&quot;].header[&quot;NEXTEND&quot;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nextend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_countEXT</span><span class="p">(</span><span class="n">extname</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1">#the simple fits image contains the data in the primary extension,</span>
            <span class="c1">#this will help us deal with the rest of the code that looks</span>
            <span class="c1">#and acts on chips :)</span>
            <span class="c1">#self._nextend=1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span><span class="o">=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="o">=</span><span class="s2">&quot;PRIMARY&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maskExt</span><span class="o">=</span><span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="s2">&quot;PRIMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PRIMARY&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="s2">&quot;PRIMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;EXTVER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="s2">&quot;PRIMARY&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extnum</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_isSimpleFits</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Clean out any stray MDRIZSKY keywords from PRIMARY headers</span>
        <span class="n">fimg</span> <span class="o">=</span> <span class="n">fileutil</span><span class="o">.</span><span class="n">openImage</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;MDRIZSKY&#39;</span> <span class="ow">in</span> <span class="n">fimg</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">fimg</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MDRIZSKY&#39;</span><span class="p">]</span>
        <span class="n">fimg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">fimg</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
            <span class="c1"># Only use selected chip</span>
            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="n">group_id</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span> <span class="c1"># user specified a specific extname,extver</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">group_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># user specified a list of extension numbers to process</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">group_id</span><span class="p">:</span>
                        <span class="c1"># find extname/extver which corresponds to this extension number</span>
                        <span class="n">group_extname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">grp</span><span class="p">)]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXTNAME&#39;</span><span class="p">]</span>
                        <span class="n">group_extver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">grp</span><span class="p">)]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXTVER&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_extver</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># find extname/extver which corresponds to this extension number</span>
                <span class="n">group_extver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">group</span><span class="p">)]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;EXTVER&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">group_extver</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use all chips</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_isSimpleFits</span><span class="p">:</span>

            <span class="c1">#assign chip specific information</span>
            <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_assignRootname</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>
                <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>

                <span class="c1"># Set a flag to indicate whether this chip should be included</span>
                <span class="c1"># or not, based on user input from the &#39;group&#39; parameter.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">chip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">):</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">group_member</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nmembers</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">group_member</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">sci_chip</span><span class="o">.</span><span class="n">signature</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">sci_chip</span><span class="o">.</span><span class="n">dqname</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">dqmaskname</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">sci_chip</span><span class="o">.</span><span class="n">dqfile</span><span class="p">,</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">dq_extn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_DQ_extension</span><span class="p">()</span>
                <span class="c1">#self.maskExt = sci_chip.dq_extn</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">dqfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">dqname</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">dqfile</span> <span class="o">+</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">dq_extn</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>

                <span class="c1"># build up HSTWCS object for each chip, which will be necessary for drizzling operations</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">wcs</span><span class="o">=</span><span class="n">wcs_functions</span><span class="o">.</span><span class="n">get_hstwcs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">,</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">extnum</span><span class="p">)</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">detnum</span><span class="p">,</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">binned</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_detnum</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span><span class="n">chip</span><span class="p">)</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">wcslin_pscale</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="c1">#assuming all the chips don&#39;t have the same dimensions in the file</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_naxis1</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS1&quot;</span><span class="p">]</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_naxis2</span><span class="o">=</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS2&quot;</span><span class="p">]</span>

                <span class="c1"># record the exptime values for this chip so that it can be</span>
                <span class="c1"># easily used to generate the composite value for the final output image</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_expstart</span><span class="p">,</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">_expend</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_expstart</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="s1">&#39;PRIMARY&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

                <span class="n">sci_chip</span><span class="o">.</span><span class="n">outputNames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_setChipOutputNames</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">rootname</span><span class="p">,</span><span class="n">chip</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#this is a dictionary</span>
                <span class="c1"># Set the units: both bunit and in_units</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_units</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span>

                <span class="c1">#initialize gain, readnoise, and exptime attributes</span>
                <span class="c1"># the actual values will be set by each instrument based on</span>
                <span class="c1"># keyword names specific to that instrument by &#39;setInstrumentParamters()&#39;</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_headergain</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># gain value read from header</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_gain</span> <span class="o">=</span> <span class="mf">1.0</span>     <span class="c1"># calibrated gain value</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_rdnoise</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># calibrated readnoise</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_exptime</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_effGain</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_conversionFactor</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">_wtscl</span> <span class="o">=</span> <span class="mf">1.0</span>

                <span class="c1"># Keep track of the sky value that should be subtracted from this chip</span>
                <span class="c1"># Read in value from image header, in case user has already</span>
                <span class="c1"># determined the sky level</span>
                <span class="c1">#</span>
                <span class="c1"># .computedSky:   value to be applied by the</span>
                <span class="c1">#                 adrizzle/ablot steps.</span>
                <span class="c1"># .subtractedSky: value already (or will be by adrizzle/ablot)</span>
                <span class="c1">#                 subtracted from the image</span>
                <span class="c1">#</span>
                <span class="k">if</span> <span class="s2">&quot;MDRIZSKY&quot;</span> <span class="ow">in</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                    <span class="n">subsky</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;MDRIZSKY&#39;</span><span class="p">]</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Reading in MDRIZSKY of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subsky</span><span class="p">)</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">subtractedSky</span> <span class="o">=</span> <span class="n">subsky</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">computedSky</span> <span class="o">=</span> <span class="n">subsky</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">subtractedSky</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">computedSky</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">sci_chip</span><span class="o">.</span><span class="n">darkcurrent</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="c1"># The following attributes are used when working with sub-arrays</span>
                <span class="c1"># and get reference file arrays for auto-generation of IVM masks</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv1</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;LTV1&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv2</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;LTV2&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv1</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv1</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv2</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">size1</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv1</span><span class="p">)</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">size2</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">ltv2</span><span class="p">)</span>
                <span class="c1">#sci_chip.image_shape = (sci_chip.size2,sci_chip.size1)</span>
                <span class="n">sci_chip</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">],</span><span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">])</span>

                <span class="c1"># Interpret the array dtype by translating the IRAF BITPIX value</span>
                <span class="k">for</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">IRAF_DTYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BITPIX&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">IRAF_DTYPES</span><span class="p">[</span><span class="n">dtype</span><span class="p">]:</span>
                        <span class="n">sci_chip</span><span class="o">.</span><span class="n">image_dtype</span> <span class="o">=</span> <span class="n">dtype</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inmemory</span><span class="p">:</span>
                    <span class="c1"># read image data array into memory</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span>


<div class="viewcode-block" id="imageObject.setInstrumentParameters"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.imageObject.setInstrumentParameters">[docs]</a>    <span class="k">def</span> <span class="nf">setInstrumentParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">instrpars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define instrument-specific parameters for use in the code.</span>
<span class="sd">            By definition, this definition will need to be overridden by</span>
<span class="sd">            methods defined in each instrument&#39;s sub-class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="imageObject.compute_wcslin"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.imageObject.compute_wcslin">[docs]</a>    <span class="k">def</span> <span class="nf">compute_wcslin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">undistort</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute the undistorted WCS based solely on the known distortion</span>
<span class="sd">            model information associated with the WCS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_numchips</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>
            <span class="n">chip_wcs</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">chip_wcs</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">undistort</span> <span class="ow">or</span> <span class="n">chip_wcs</span><span class="o">.</span><span class="n">instrument</span><span class="o">==</span><span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span>
                <span class="n">chip_wcs</span><span class="o">.</span><span class="n">sip</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">chip_wcs</span><span class="o">.</span><span class="n">cpdis1</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">chip_wcs</span><span class="o">.</span><span class="n">cpdis2</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">chip_wcs</span><span class="o">.</span><span class="n">det2im</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">undistort</span><span class="o">=</span><span class="kc">False</span>

            <span class="c1"># compute the undistorted &#39;natural&#39; plate scale for this chip</span>
            <span class="n">wcslin</span> <span class="o">=</span> <span class="n">distortion</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">output_wcs</span><span class="p">([</span><span class="n">chip_wcs</span><span class="p">],</span><span class="n">undistort</span><span class="o">=</span><span class="n">undistort</span><span class="p">)</span>
            <span class="n">sci_chip</span><span class="o">.</span><span class="n">wcslin_pscale</span> <span class="o">=</span> <span class="n">wcslin</span><span class="o">.</span><span class="n">pscale</span></div>

<div class="viewcode-block" id="imageObject.set_units"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.imageObject.set_units">[docs]</a>    <span class="k">def</span> <span class="nf">set_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chip</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Define units for this image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Determine output value of BUNITS</span>
        <span class="c1"># and make sure it is not specified as &#39;ergs/cm...&#39;</span>
        <span class="n">sci_chip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scienceExt</span><span class="p">,</span><span class="n">chip</span><span class="p">]</span>

        <span class="n">_bunit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;BUNIT&#39;</span> <span class="ow">in</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ergs&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_bunit</span> <span class="o">=</span> <span class="n">sci_chip</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;BUNIT&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_bunit</span> <span class="o">=</span> <span class="s1">&#39;ELECTRONS/S&#39;</span>
        <span class="n">sci_chip</span><span class="o">.</span><span class="n">_bunit</span> <span class="o">=</span> <span class="n">_bunit</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="s1">&#39;/s&#39;</span> <span class="ow">in</span> <span class="n">_bunit</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">_in_units</span> <span class="o">=</span> <span class="s1">&#39;cps&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_in_units</span> <span class="o">=</span> <span class="s1">&#39;counts&#39;</span>
        <span class="n">sci_chip</span><span class="o">.</span><span class="n">in_units</span> <span class="o">=</span> <span class="n">_in_units</span></div></div>



<div class="viewcode-block" id="WCSObject"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.WCSObject">[docs]</a><span class="k">class</span> <span class="nc">WCSObject</span><span class="p">(</span><span class="n">baseImageObject</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_drz&#39;</span><span class="p">):</span>
        <span class="n">baseImageObject</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">())</span>

        <span class="c1"># Build rootname, but guard against the rootname being given without</span>
        <span class="c1"># the &#39;_drz.fits&#39; suffix</span>
        <span class="c1">#patt = re.compile(r&quot;_dr[zc]\w*.fits$&quot;)</span>
        <span class="n">drz_extn</span> <span class="o">=</span> <span class="n">suffix</span>
        <span class="n">patt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">r&quot;_dr[zc]&quot;</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">patt</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
            <span class="n">drz_extn</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Guard against having .fits in the rootname</span>
            <span class="k">if</span> <span class="s1">&#39;.fits&#39;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="n">filename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">)]</span>
                <span class="n">drz_extn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outputNames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setOutputNames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rootname</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="n">drz_extn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bunit</span> <span class="o">=</span> <span class="s1">&#39;ELECTRONS/S&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_wcs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_wcs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">single_wcs</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="WCSObject.restore_wcs"><a class="viewcode-back" href="../../baseobjects.html#drizzlepac.imageObject.WCSObject.restore_wcs">[docs]</a>    <span class="k">def</span> <span class="nf">restore_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_wcs</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DrizzlePac 2.1.15 (26-May-2017) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Warren Hack, Nadia Dencheva, Chris Sontag, Megan Sosey, Michael Droettboom, Mihai Cara.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>