<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>drizzlepac.imgclasses &#8212; DrizzlePac 2.1.15 (26-May-2017) documentation</title>
    
    <link rel="stylesheet" href="../../_static/stsci_sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.1.15 (26-May-2017)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DrizzlePac 2.1.15 (26-May-2017) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/stsci_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for drizzlepac.imgclasses</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Classes to keep track of all WCS and catalog information.</span>
<span class="sd">Used by `TweakReg`\ .</span>

<span class="sd">:Authors: Warren Hack, Mihai Cara</span>

<span class="sd">:License: `&lt;http://www.stsci.edu/resources/software_hardware/pyraf/LICENSE&gt;`_</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">wcs</span> <span class="k">as</span> <span class="n">pywcs</span>
<span class="kn">import</span> <span class="nn">stwcs</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">stsci.sphere.polygon</span> <span class="k">import</span> <span class="n">SphericalPolygon</span>
<span class="kn">from</span> <span class="nn">stsci.skypac.parseat</span> <span class="k">import</span> <span class="n">FileExtMaskInfo</span><span class="p">,</span> <span class="n">parse_cs_line</span>
<span class="kn">from</span> <span class="nn">stsci.skypac</span> <span class="k">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">spu</span>

<span class="kn">from</span> <span class="nn">stwcs</span> <span class="k">import</span> <span class="n">distortion</span>
<span class="kn">from</span> <span class="nn">stwcs.distortion</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">stwcs.wcsutil</span> <span class="k">import</span> <span class="n">wcscorr</span>
<span class="kn">from</span> <span class="nn">stwcs.wcsutil</span> <span class="k">import</span> <span class="n">headerlet</span>
<span class="kn">from</span> <span class="nn">stwcs.wcsutil</span> <span class="k">import</span> <span class="n">altwcs</span>
<span class="kn">from</span> <span class="nn">stsci.tools</span> <span class="k">import</span> <span class="n">fileutil</span> <span class="k">as</span> <span class="n">fu</span>
<span class="kn">from</span> <span class="nn">stsci.stimage</span> <span class="k">import</span> <span class="n">xyxymatch</span>
<span class="kn">from</span> <span class="nn">stsci.tools</span> <span class="k">import</span> <span class="n">logutil</span><span class="p">,</span> <span class="n">textutil</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">stsci.tools.bitmask</span> <span class="k">import</span> <span class="n">interpret_bit_flags</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">stsci.tools.bitmask</span> <span class="k">import</span> <span class="n">interpret_bits_value</span> <span class="k">as</span> <span class="n">interpret_bit_flags</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">catalogs</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">linearfit</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">updatehdr</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tweakutils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">wcs_functions</span>

<span class="c1"># DEBUG</span>
<span class="n">IMGCLASSES_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># use convex hull for images? (this is tighter than chip&#39;s bounding box)</span>
<span class="n">IMAGE_USE_CONVEX_HULL</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logutil</span><span class="o">.</span><span class="n">create_logger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">sortKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;minflux&#39;</span><span class="p">,</span><span class="s1">&#39;maxflux&#39;</span><span class="p">,</span><span class="s1">&#39;nbright&#39;</span><span class="p">,</span><span class="s1">&#39;fluxunits&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="Image"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image">[docs]</a><span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Primary class to keep track of all WCS and catalog information for</span>
<span class="sd">        a single input image. This class also performs all matching and fitting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">input_catalogs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str</span>
<span class="sd">            Filename for image.</span>

<span class="sd">        input_catalogs : list of str or None</span>
<span class="sd">            Filename of catalog files for each chip, if specified by user.</span>

<span class="sd">        kwargs : dict</span>
<span class="sd">            Parameters necessary for processing derived from input configObj object.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_im</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">ImageRef</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dq</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">ImageRef</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dqbits</span> <span class="o">=</span> <span class="n">interpret_bit_flags</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;dqbits&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;use_sharp_round&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;use_sharp_round&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;updatehdr&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;update&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">open_mode</span> <span class="o">=</span> <span class="s1">&#39;readonly&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_root</span> <span class="o">=</span> <span class="n">fu</span><span class="o">.</span><span class="n">parseFilename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openFile</span><span class="p">(</span><span class="n">openDQ</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dqbits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_sci</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># try to verify whether or not this image has been updated with</span>
            <span class="c1"># a full distortion model</span>
            <span class="n">num_sci</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">count_extensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="s1">&#39;SCI&#39;</span><span class="p">)</span>

        <span class="n">numwht</span> <span class="o">=</span> <span class="n">spu</span><span class="o">.</span><span class="n">count_extensions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="s1">&#39;WHT&#39;</span><span class="p">)</span>

        <span class="n">wcsextn</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">findWCSExtn</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1">#wnames = altwcs.wcsnames(self._im.hdu, ext=((&#39;SCI&#39;,1) if num_sci &gt; 0 else 0))</span>
        <span class="c1"># If no WCSNAME keywords were found, raise the possibility that</span>
        <span class="c1"># the images have not been updated fully and may result in inaccurate</span>
        <span class="c1"># alignment</span>
        <span class="c1"># use &#39;numwht&#39; != 0 to indicate a DRZ file has been specified as input</span>
        <span class="c1">#if len(wnames) == 0 and numwht == 0:</span>
        <span class="k">if</span> <span class="n">wcsextn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span><span class="s1">&#39;WARNING:</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;Image </span><span class="si">%s</span><span class="s1"> may not have the full correct &#39;</span><span class="o">%</span><span class="n">filename</span><span class="o">+</span>
            <span class="s1">&#39;WCS solution in the header as created by stwcs.updatewcs &#39;</span>
            <span class="s1">&#39;Image alignment may not be taking into account &#39;</span>
            <span class="s1">&#39;the full distortion solution.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="s1">&#39;Turning on the &quot;updatewcs&quot; parameter would insure &#39;</span>
            <span class="s1">&#39;that each image uses the full distortion model when &#39;</span>
            <span class="s1">&#39;aligning this image.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">60</span>
            <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rootname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclusions</span> <span class="o">=</span> <span class="n">exclusions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interactive&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Record this for use with methods</span>
        <span class="k">if</span> <span class="n">num_sci</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nvers</span> <span class="o">=</span> <span class="n">num_sci</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span> <span class="o">=</span> <span class="s1">&#39;SCI&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nvers</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span> <span class="o">=</span> <span class="s1">&#39;PRIMARY&#39;</span>

        <span class="c1"># WCS required, so verify that we can get one</span>
        <span class="c1"># Need to count number of SCI extensions</span>
        <span class="c1">#  (assume a valid WCS with each SCI extension)</span>
        <span class="c1">#TODO: current check for a valid WCS may need a revision to</span>
        <span class="c1"># implement a more robust/rigurous check.</span>
        <span class="c1"># This verification has already been done when finding &#39;wcsextn&#39;</span>


        <span class="c1"># Need to generate a separate catalog for each chip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">xypostypes</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">object</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xypostypes</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_sources</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Analyze exclusion file list:</span>
        <span class="k">if</span> <span class="n">exclusions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nexclusions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclusions</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nexclusions</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="p">:</span>
                <span class="n">exclusions</span> <span class="o">=</span> <span class="n">exclusions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exclusions</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="o">-</span><span class="n">nexclusions</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span> <span class="kc">None</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exclusions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nvers</span> <span class="o">*</span> <span class="p">[</span> <span class="kc">None</span> <span class="p">]</span>

        <span class="c1"># For each SCI extension, generate a catalog and WCS</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===  Source finding for image &#39;</span><span class="si">{}</span><span class="s2">&#39;:&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

        <span class="n">bounding_polygons</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">chip_filenames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sci_extn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">extnum</span> <span class="o">=</span> <span class="n">fu</span><span class="o">.</span><span class="n">findExtname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span><span class="p">,</span> <span class="n">extver</span><span class="o">=</span><span class="n">sci_extn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extnum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">extnum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">chip_filenames</span><span class="p">[</span><span class="n">sci_extn</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:s}</span><span class="s2">[</span><span class="si">{:d}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">extnum</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">sci_extn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">chip_filename</span> <span class="o">=</span> <span class="n">chip_filenames</span><span class="p">[</span><span class="n">sci_extn</span><span class="p">]</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="n">stwcs</span><span class="o">.</span><span class="n">wcsutil</span><span class="o">.</span><span class="n">HSTWCS</span><span class="p">(</span><span class="n">chip_filename</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">input_catalogs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># if we already have a set of catalogs provided on input,</span>
                <span class="c1">#  we only need the array to get original XY input positions</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">chip_filename</span>
                <span class="n">catalog_mode</span><span class="o">=</span><span class="s1">&#39;automatic&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">input_catalogs</span><span class="p">[</span><span class="n">sci_extn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">catalog_mode</span><span class="o">=</span><span class="s1">&#39;user&#39;</span>

            <span class="k">if</span> <span class="n">exclusions</span><span class="p">[</span><span class="n">sci_extn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;INDEF&#39;</span> <span class="p">]:</span>
                <span class="n">excludefile</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;region_file&#39;</span><span class="p">:</span> <span class="n">exclusions</span><span class="p">[</span><span class="n">sci_extn</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">excludefile</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;start_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_sources</span>
            <span class="n">catalog</span> <span class="o">=</span> <span class="n">catalogs</span><span class="o">.</span><span class="n">generateCatalog</span><span class="p">(</span><span class="n">wcs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">catalog_mode</span><span class="p">,</span>
                        <span class="n">catalog</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">src_find_filters</span><span class="o">=</span><span class="n">excludefile</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># creaate DQ mask:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dqbits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># make sure DQ data are available:</span>
                <span class="n">dq_available</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dq</span><span class="o">.</span><span class="n">closed</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dqext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                   <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dqext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dq</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_dqext</span><span class="p">[</span><span class="n">sci_extn</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">dq_available</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">pass</span>

                <span class="k">if</span> <span class="n">dq_available</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">dqbits</span><span class="p">)</span>
                                          <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span>
                            <span class="s2">&quot;WARNING: User requested to use &quot;</span>
                            <span class="s2">&quot;DQ mask for source finding, but DQ data are &quot;</span>
                            <span class="s2">&quot;not available.</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="s2">&quot;DQ mask WILL NOT be used for source finding.&quot;</span><span class="p">,</span>
                            <span class="n">indent</span> <span class="o">=</span> <span class="mi">5</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

            <span class="c1"># read in and convert all catalog positions to RA/Dec</span>
            <span class="n">catalog</span><span class="o">.</span><span class="n">buildCatalogs</span><span class="p">(</span><span class="n">exclusions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">num_sources</span> <span class="o">+=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">num_objects</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">sci_extn</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;catalog&#39;</span><span class="p">:</span><span class="n">catalog</span><span class="p">,</span><span class="s1">&#39;wcs&#39;</span><span class="p">:</span><span class="n">wcs</span><span class="p">}</span>

            <span class="c1"># Merge input X,Y positions from all chips into a single catalog</span>
            <span class="c1"># This will be used for writing output matched source catalogs</span>
            <span class="n">nxypos</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">nxypos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nsrc</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nxypos</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># add &quot;source origin&quot;:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nsrc</span><span class="o">*</span><span class="p">[</span><span class="n">source</span><span class="p">]))</span>

                <span class="c1"># Compute bounding convex hull for the reference catalog:</span>
                <span class="k">if</span> <span class="n">IMAGE_USE_CONVEX_HULL</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># if catalog.xypos[0].shape[0] &lt; 3:</span>
                    <span class="n">xy_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">convex_hull</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()))),</span>
                                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">xy_vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">rdv</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">xy_vertices</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">bounding_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SphericalPolygon</span><span class="o">.</span><span class="n">from_radec</span><span class="p">(</span><span class="n">rdv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rdv</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bounding_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SphericalPolygon</span><span class="o">.</span><span class="n">from_wcs</span><span class="p">(</span><span class="n">wcs</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">IMGCLASSES_DEBUG</span><span class="p">:</span>
                        <span class="n">all_ra</span><span class="p">,</span> <span class="n">all_dec</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span>
                            <span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">_debug_write_region_fk5</span><span class="p">(</span><span class="s1">&#39;dbg_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="o">+</span><span class="s1">&#39;_bounding_polygon.reg&#39;</span><span class="p">,</span>
                                                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">rdv</span><span class="o">.</span><span class="n">transpose</span><span class="p">())),</span>
                                                <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">catalog</span><span class="o">.</span><span class="n">radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">catalog</span><span class="o">.</span><span class="n">radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]])),</span>
                                                <span class="n">append</span><span class="o">=</span><span class="n">sci_extn</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bounding_polygons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">SphericalPolygon</span><span class="o">.</span><span class="n">from_wcs</span><span class="p">(</span><span class="n">wcs</span><span class="p">))</span>

        <span class="n">npoly</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounding_polygons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npoly</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyline</span> <span class="o">=</span> <span class="n">SphericalPolygon</span><span class="o">.</span><span class="n">multi_union</span><span class="p">(</span><span class="n">bounding_polygons</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">npoly</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyline</span> <span class="o">=</span> <span class="n">bounding_polygons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyline</span> <span class="o">=</span> <span class="n">SphericalPolygon</span><span class="p">([])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Build full list of all sky positions from all chips</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buildSkyCatalog</span><span class="p">()</span>
        <span class="n">tsrc</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===  Found a TOTAL of </span><span class="si">{:d}</span><span class="s2"> objects in image &#39;</span><span class="si">{:s}</span><span class="s2">&#39;&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tsrc</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;writecat&#39;</span><span class="p">]:</span>
            <span class="n">catname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="o">+</span><span class="s2">&quot;_sky_catalog.coo&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="o">+</span><span class="s2">&quot;_xy_catalog.match&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_skycatalog</span><span class="p">(</span><span class="n">catname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;sky&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span> <span class="c1"># Keep track of catalogs being written out</span>
            <span class="k">for</span> <span class="n">nsci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">catname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_sci</span><span class="si">%d</span><span class="s2">_xy_catalog.coo&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="p">,</span><span class="n">nsci</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">nsci</span><span class="p">][</span><span class="s1">&#39;catalog&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">writeXYCatalog</span><span class="p">(</span><span class="n">catname</span><span class="p">)</span>
                <span class="c1"># Keep track of catalogs being written out</span>
                <span class="k">if</span> <span class="s1">&#39;input_xy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;input_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;input_xy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;fitmatch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="o">+</span><span class="s2">&quot;_catalog_fit.match&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Set up products which need to be computed by methods of this class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># reference WCS assigned for the final fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;image&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;ref&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span> <span class="c1"># stores matched list of coordinates for fitting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># stores result of fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_pars</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_pars</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identityfit</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># set to True when matching/fitting to itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">goodmatch</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># keep track of whether enough matches were found for a fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure_id</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">next_key</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quit_immediately</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># close file handle... for now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="Image.close"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Close any open file handles and flush updates to disk</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dq</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="Image.openFile"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.openFile">[docs]</a>    <span class="k">def</span> <span class="nf">openFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">openDQ</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Open file and set up filehandle for image file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dq</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_dq</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dq</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>
            <span class="n">fi</span> <span class="o">=</span> <span class="n">FileExtMaskInfo</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">doNotOpenDQ</span><span class="o">=</span><span class="ow">not</span> <span class="n">openDQ</span><span class="p">,</span>
                                 <span class="n">im_fmode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">open_mode</span><span class="p">)</span>
            <span class="n">fi</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_im</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">image</span>
            <span class="n">fi</span><span class="o">.</span><span class="n">append_ext</span><span class="p">(</span><span class="n">spu</span><span class="o">.</span><span class="n">get_ext_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="s1">&#39;SCI&#39;</span><span class="p">))</span>
            <span class="n">fi</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_im</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">image</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dq</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">DQimage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_imext</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">fext</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dqext</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">dqext</span></div>

<div class="viewcode-block" id="Image.get_wcs"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.get_wcs">[docs]</a>    <span class="k">def</span> <span class="nf">get_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method to return a list of all the input WCS objects associated</span>
<span class="sd">            with this image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wcslist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">:</span>
            <span class="n">wcslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">chip</span><span class="p">][</span><span class="s1">&#39;wcs&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">wcslist</span></div>

<div class="viewcode-block" id="Image.buildSkyCatalog"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.buildSkyCatalog">[docs]</a>    <span class="k">def</span> <span class="nf">buildSkyCatalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert sky catalog for all chips into a single catalog for</span>
<span class="sd">            the entire field-of-view of this image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ralist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">declist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fluxlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scichip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">:</span>
            <span class="n">skycat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">scichip</span><span class="p">][</span><span class="s1">&#39;catalog&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">radec</span>
            <span class="n">xycat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">scichip</span><span class="p">][</span><span class="s1">&#39;catalog&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xypos</span>
            <span class="k">if</span> <span class="n">skycat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ralist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skycat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">declist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skycat</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xycat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">fluxlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xycat</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">idlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xycat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">skycat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">fluxlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skycat</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">idlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skycat</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fluxlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">999.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">skycat</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">idlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">skycat</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>


                <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ralist</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">declist</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">fluxlist</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">idlist</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.buildDefaultRefWCS"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.buildDefaultRefWCS">[docs]</a>    <span class="k">def</span> <span class="nf">buildDefaultRefWCS</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generate a default reference WCS for this image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_refWCS</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_wcs</span><span class="p">:</span>
            <span class="n">wcslist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">scichip</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">:</span>
                <span class="n">wcslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">scichip</span><span class="p">][</span><span class="s1">&#39;wcs&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_refWCS</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">output_wcs</span><span class="p">(</span><span class="n">wcslist</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.transformToRef"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.transformToRef">[docs]</a>    <span class="k">def</span> <span class="nf">transformToRef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ref_wcs</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Transform sky coords from ALL chips into X,Y coords in reference WCS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_wcs</span><span class="p">,</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span><span class="s1">&#39;Reference WCS not a valid HSTWCS object&#39;</span><span class="p">),</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1"># Need to concatenate catalogs from each input</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">outxy</span> <span class="o">=</span> <span class="n">ref_wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="c1"># convert outxy list to a Nx2 array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">outxy</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">outxy</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;writecat&#39;</span><span class="p">]:</span>
                <span class="n">catname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="o">+</span><span class="s2">&quot;_refxy_catalog.coo&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_outxy</span><span class="p">(</span><span class="n">catname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;ref_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catname</span></div>

<div class="viewcode-block" id="Image.sortSkyCatalog"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.sortSkyCatalog">[docs]</a>    <span class="k">def</span> <span class="nf">sortSkyCatalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sort and clip the source catalog based on the flux range specified</span>
<span class="sd">            by the user.</span>
<span class="sd">            It keeps a copy of the original full list in order to support iteration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warn_str</span> <span class="o">=</span> <span class="s2">&quot;Source catalog NOT trimmed by flux/mag. No fluxes read in for sources!&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: &#39;</span><span class="p">,</span><span class="n">warn_str</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_str</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">clip_catalog</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">clip_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sortKeys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pindx</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pindx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;found a match for </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">p</span><span class="p">])))</span>
                    <span class="c1"># find prefix (if any)</span>
                    <span class="n">clip_prefix</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:</span><span class="n">pindx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="c1">#Only clip the catalog if one of the keys is specified</span>
                    <span class="c1"># in the catalog parameters, not the source finding pars</span>
                    <span class="k">if</span> <span class="n">clip_prefix</span> <span class="ow">and</span> <span class="s1">&#39;units&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                        <span class="n">clip_catalog</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">clip_catalog</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">all_radec</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">clip_catalog</span><span class="p">:</span>

            <span class="c1"># Start by clipping by any specified flux range</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;maxflux&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;minflux&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clip_catalog</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;minflux&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fluxmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;minflux&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fluxmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;maxflux&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fluxmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;maxflux&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fluxmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="c1"># apply flux limit clipping</span>
                <span class="n">minindx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">fluxmin</span>
                <span class="n">maxindx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fluxmax</span>
                <span class="n">flux_indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">minindx</span><span class="p">,</span><span class="n">maxindx</span><span class="p">)</span>
                <span class="n">all_radec</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">all_radec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">flux_indx</span><span class="p">])</span>
                <span class="n">all_radec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">flux_indx</span><span class="p">])</span>
                <span class="n">all_radec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">flux_indx</span><span class="p">])</span>
                <span class="n">all_radec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">flux_indx</span><span class="p">])))</span>

            <span class="k">if</span> <span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;nbright&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="ow">and</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;nbright&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">clip_catalog</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">nbright</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;nbright&#39;</span><span class="p">]</span>

                <span class="c1"># pick out only the brightest &#39;nbright&#39; sources</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="n">clip_prefix</span><span class="o">+</span><span class="s1">&#39;fluxunits&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mag&#39;</span><span class="p">:</span>
                    <span class="n">nbslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">nbright</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nbslice</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">nbright</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">all_radec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># work on copy of all original data</span>
                    <span class="n">all_radec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec_orig</span><span class="p">)</span>
                <span class="c1"># find indices of brightest</span>
                <span class="n">nbright_indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="n">nbslice</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nbright_indx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">nbright_indx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">nbright_indx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">nbright_indx</span><span class="p">]))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">all_radec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">all_radec</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.match"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">refimage</span><span class="p">,</span> <span class="n">quiet_identity</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Uses xyxymatch to cross-match sources between this catalog and</span>
<span class="sd">            a reference catalog (refCatalog).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref_outxy</span> <span class="o">=</span> <span class="n">refimage</span><span class="o">.</span><span class="n">outxy</span>
        <span class="n">refWCS</span> <span class="o">=</span> <span class="n">refimage</span><span class="o">.</span><span class="n">wcs</span>
        <span class="n">refname</span> <span class="o">=</span> <span class="n">refimage</span><span class="o">.</span><span class="n">name</span>
        <span class="n">ref_inxy</span> <span class="o">=</span> <span class="n">refimage</span><span class="o">.</span><span class="n">xy_catalog</span>

        <span class="n">cat_src_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cat_src_type&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cat_src_type&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet_identity</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matching sources from </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s2"> with sources from &quot;</span>
                  <span class="s2">&quot;reference </span><span class="si">{}</span><span class="s2"> </span><span class="se">\&#39;</span><span class="si">{}</span><span class="se">\&#39;</span><span class="s2">&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cat_src_type</span><span class="p">,</span> <span class="n">refname</span><span class="p">))</span>
        <span class="c1">#self.sortSkyCatalog() # apply any catalog sorting specified by the user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformToRef</span><span class="p">(</span><span class="n">refWCS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span> <span class="o">=</span> <span class="n">refWCS</span>
        <span class="c1"># extract xyxymatch parameters from input parameters</span>
        <span class="n">matchpars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_pars</span> <span class="o">=</span> <span class="n">matchpars</span>
        <span class="n">minobj</span> <span class="o">=</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;minobj&#39;</span><span class="p">]</span> <span class="c1"># needed for later</span>
        <span class="k">del</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;minobj&#39;</span><span class="p">]</span> <span class="c1"># not needed in xyxymatch</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">goodmatch</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check to see whether or not it is being matched to itself</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">refname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span><span class="c1"># or (</span>
<span class="c1">#                ref_outxy.shape == self.outxy.shape) and (</span>
<span class="c1">#                ref_outxy == self.outxy).all():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identityfit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet_identity</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NO fit performed for reference image: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># convert tolerance from units of arcseconds to pixels, as needed</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;searchrad&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;searchunits&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;arcseconds&#39;</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">/=</span> <span class="n">refWCS</span><span class="o">.</span><span class="n">pscale</span>

            <span class="c1"># Determine xyoff (X,Y offset) and tolerance to be used with xyxymatch</span>
            <span class="n">use2d</span> <span class="o">=</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;use2dhist&#39;</span><span class="p">]</span>
            <span class="n">xyxysep</span> <span class="o">=</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;separation&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">use2d</span><span class="p">:</span>
                <span class="n">hist_name</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                    <span class="n">hist_name</span> <span class="o">=</span> <span class="s1">&#39;hist2d_</span><span class="si">{0}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="p">)</span>
                <span class="n">zpxoff</span><span class="p">,</span><span class="n">zpyoff</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">zpqual</span> <span class="o">=</span> <span class="n">tweakutils</span><span class="o">.</span><span class="n">build_xy_zeropoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="p">,</span>
                                    <span class="n">ref_outxy</span><span class="p">,</span><span class="n">searchrad</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span>
                                    <span class="n">histplot</span><span class="o">=</span><span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;see2dplot&#39;</span><span class="p">],</span>
                                    <span class="n">interactive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">,</span>
                                    <span class="n">figure_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure_id</span><span class="p">,</span> <span class="n">plotname</span><span class="o">=</span><span class="n">hist_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;see2dplot&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;residplot&#39;</span> <span class="ow">in</span> <span class="n">matchpars</span> <span class="ow">and</span>
                                               <span class="s1">&#39;No&#39;</span> <span class="ow">in</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;residplot&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                        <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Press ENTER for next image, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                                  <span class="s2">&quot;     &#39;n&#39; to continue without updating header or </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                                  <span class="s2">&quot;     &#39;q&#39; to quit immediately...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;q&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">quit_immediately</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;see2dplot&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">figure_id</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">zpqual</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">xyoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">zpxoff</span><span class="p">,</span><span class="n">zpyoff</span><span class="p">)</span>
                    <span class="c1"># set tolerance as well</span>
                    <span class="c1"># This value allows initial guess to be off by 1 in both and</span>
                    <span class="c1"># still pick up the identified matches</span>
                    <span class="n">xyxytolerance</span> <span class="o">=</span> <span class="mf">1.5</span>
                    <span class="c1">#xyxysep = 0.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">use2d</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">use2d</span><span class="p">:</span>
                <span class="n">xoff</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">yoff</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_blank</span><span class="p">(</span><span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;xoffset&#39;</span><span class="p">]):</span>
                    <span class="n">xoff</span> <span class="o">=</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;xoffset&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_blank</span><span class="p">(</span><span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;yoffset&#39;</span><span class="p">]):</span>
                    <span class="n">yoff</span> <span class="o">=</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;yoffset&#39;</span><span class="p">]</span>
                <span class="n">xyoff</span> <span class="o">=</span> <span class="p">(</span><span class="n">xoff</span><span class="p">,</span><span class="n">yoff</span><span class="p">)</span>
                <span class="c1"># set tolerance based on user-specified input</span>
                <span class="n">xyxytolerance</span> <span class="o">=</span> <span class="n">matchpars</span><span class="p">[</span><span class="s1">&#39;tolerance&#39;</span><span class="p">]</span>

            <span class="n">matches</span> <span class="o">=</span> <span class="n">xyxymatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="p">,</span><span class="n">ref_outxy</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="n">xyoff</span><span class="p">,</span>
                                <span class="n">tolerance</span><span class="o">=</span><span class="n">xyxytolerance</span><span class="p">,</span><span class="n">separation</span><span class="o">=</span><span class="n">xyxysep</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">minobj</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_x&#39;</span><span class="p">][:,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_y&#39;</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_x&#39;</span><span class="p">][:,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_y&#39;</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_idx&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_orig_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ref_inxy</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_idx&#39;</span><span class="p">]][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ref_inxy</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_idx&#39;</span><span class="p">]][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_orig_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;src_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref_inxy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_idx&#39;</span><span class="p">]]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%d</span><span class="s1"> matches for </span><span class="si">%s</span><span class="s1">...&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;writecat&#39;</span><span class="p">]:</span>
                    <span class="n">matchfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;match&#39;</span><span class="p">],</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">)</span>
                    <span class="n">matchfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#Reference: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">refname</span><span class="p">)</span>
                    <span class="n">matchfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#Input: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;#Ref_X        Ref_Y        &#39;</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Input_X    Input_Y        &#39;</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Ref_X0    Ref_Y0        &#39;</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Input_X0    Input_Y0        &#39;</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Ref_ID    Input_ID        &#39;</span>
                    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Ref_Source</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">fmtstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.6f</span><span class="s1">    </span><span class="si">%0.6f</span><span class="s1">        &#39;</span><span class="o">*</span><span class="mi">4</span>
                    <span class="n">fmtstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">    </span><span class="si">%d</span><span class="s1">    </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">matchfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_x&#39;</span><span class="p">])):</span>
                        <span class="n">linestr</span> <span class="o">=</span> <span class="n">fmtstr</span><span class="o">%</span>\
                            <span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_x&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_y&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>\
                             <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_x&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_y&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_idx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;src_origin&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">matchfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">linestr</span><span class="p">)</span>
                    <span class="n">matchfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnstr</span> <span class="o">=</span> <span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span><span class="s1">&#39;WARNING: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span>
                    <span class="s1">&#39;Not enough matches (&lt; </span><span class="si">%d</span><span class="s1">) found for input image: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">minobj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">warnstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">warnstr</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">goodmatch</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Image.performFit"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.performFit">[docs]</a>    <span class="k">def</span> <span class="nf">performFit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform a fit between the matched sources.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            kwargs : dict</span>
<span class="sd">                Parameter necessary to perform the fit; namely, *fitgeometry*.</span>

<span class="sd">            Notes</span>
<span class="sd">            -----</span>
<span class="sd">            This task still needs to implement (eventually) interactive iteration of</span>
<span class="sd">                   the fit to remove outliers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_pars</span> <span class="o">=</span> <span class="n">pars</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;offset&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="s1">&#39;rot&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;scale&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="p">],</span><span class="s1">&#39;rms&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span>
                    <span class="s1">&#39;rms_keys&#39;</span><span class="p">:{</span><span class="s1">&#39;RMS_RA&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;RMS_DEC&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;NMATCH&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span>
                    <span class="s1">&#39;fit_matrix&#39;</span><span class="p">:[[</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]],</span> <span class="s1">&#39;src_origin&#39;</span><span class="p">:[</span><span class="kc">None</span><span class="p">]}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identityfit</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">goodmatch</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="n">linearfit</span><span class="o">.</span><span class="n">iter_fit_all</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_idx&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_idx&#39;</span><span class="p">],</span>
                    <span class="n">xyorig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;img_orig_xy&#39;</span><span class="p">],</span>
                    <span class="n">uvorig</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;ref_orig_xy&#39;</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fitgeometry&#39;</span><span class="p">],</span><span class="n">nclip</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;nclip&#39;</span><span class="p">],</span>
                    <span class="n">sigma</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span><span class="n">minobj</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;minobj&#39;</span><span class="p">],</span>
                    <span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_fit_rms</span><span class="p">()</span>
                <span class="n">xy_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_coords&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;resids&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xy_fit</span>
                <span class="n">radec_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span><span class="o">.</span><span class="n">all_pix2world</span><span class="p">(</span><span class="n">xy_fit</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_RA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_fit</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_DEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radec_fit</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;src_origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;src_origin&#39;</span><span class="p">]</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Computed &#39;</span><span class="p">,</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fitgeometry&#39;</span><span class="p">],</span><span class="s1">&#39; fit for &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="s1">&#39;: &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fitgeometry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;shift&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XSH: </span><span class="si">{:.6g}</span><span class="s2">  YSH: </span><span class="si">{:.6g}</span><span class="s2">&quot;</span>
                          <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fitgeometry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rscale&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;proper&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XSH: </span><span class="si">{:.6g}</span><span class="s2">  YSH: </span><span class="si">{:.6g}</span><span class="s2">    ROT: </span><span class="si">{:.6g}</span><span class="s2">    &quot;</span>
                          <span class="s2">&quot;SCALE: </span><span class="si">{:.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fitgeometry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;general&#39;</span> <span class="ow">or</span> \
                     <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;fitgeometry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rscale&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;proper&#39;</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XSH: </span><span class="si">{:.6g}</span><span class="s2">  YSH: </span><span class="si">{:.6g}</span><span class="s2">    PROPER ROT: </span><span class="si">{:.6g}</span><span class="s2">    &quot;</span>
                          <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;ROT&gt;: </span><span class="si">{:.6g}</span><span class="s2">  SKEW: </span><span class="si">{:.6g}</span><span class="s2">    ROT_X: </span><span class="si">{:.6g}</span><span class="s2">  &quot;</span>
                          <span class="s2">&quot;ROT_Y: </span><span class="si">{:.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rotxy&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;skew&#39;</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rotxy&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rotxy&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;SCALE&gt;: </span><span class="si">{:.6g}</span><span class="s2">  SCALE_X: </span><span class="si">{:.6g}</span><span class="s2">  &quot;</span>
                          <span class="s2">&quot;SCALE_Y: </span><span class="si">{:.6g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;XRMS: </span><span class="si">%0.6g</span><span class="s1">    YRMS: </span><span class="si">%0.6g</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RMS_RA: </span><span class="si">%g</span><span class="s1"> (deg)   RMS_DEC: </span><span class="si">%g</span><span class="s1"> (deg)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">][</span><span class="s1">&#39;RMS_RA&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">][</span><span class="s1">&#39;RMS_DEC&#39;</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Final solution based on &#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">][</span><span class="s1">&#39;NMATCH&#39;</span><span class="p">],</span><span class="s1">&#39; objects.&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">write_fit_catalog</span><span class="p">()</span>

                <span class="c1"># Plot residuals, if requested by the user</span>
                <span class="k">if</span> <span class="s1">&#39;residplot&#39;</span> <span class="ow">in</span> <span class="n">pars</span> <span class="ow">and</span> <span class="s2">&quot;No&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;residplot&#39;</span><span class="p">]:</span>
                    <span class="n">xy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_coords&#39;</span><span class="p">]</span>
                    <span class="n">resids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;resids&#39;</span><span class="p">]</span>
                    <span class="n">xy_fit</span> <span class="o">=</span> <span class="n">xy</span> <span class="o">+</span> <span class="n">resids</span>
                    <span class="n">title_str</span> <span class="o">=</span> <span class="s1">&#39;Residuals\ for\ </span><span class="si">{0}</span><span class="s1">\ using\ </span><span class="si">{1:6d}</span><span class="s1">\ sources&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;\_&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">][</span><span class="s1">&#39;NMATCH&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                        <span class="n">resid_name</span> <span class="o">=</span> <span class="s1">&#39;residuals_</span><span class="si">{0}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rootname</span><span class="p">)</span>
                        <span class="n">vector_name</span> <span class="o">=</span> <span class="n">resid_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;residuals&#39;</span><span class="p">,</span><span class="s1">&#39;vector&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resid_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">vector_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;residplot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;both&#39;</span><span class="p">:</span>
                        <span class="n">tweakutils</span><span class="o">.</span><span class="n">make_vector_plot</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">xy_fit</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">xy_fit</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]],</span>
                            <span class="n">figure_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figure_id</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">labelsize</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;labelsize&#39;</span><span class="p">],</span>
                            <span class="n">plotname</span><span class="o">=</span><span class="n">vector_name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title_str</span><span class="p">)</span>
                        <span class="n">ptype</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># Setup</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">figure_id</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;residplot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;vector&#39;</span><span class="p">:</span>
                        <span class="n">ptype</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ptype</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># Generate new plot</span>
                    <span class="n">tweakutils</span><span class="o">.</span><span class="n">make_vector_plot</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">xy_fit</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">xy_fit</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]],</span>
                        <span class="n">figure_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figure_id</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="n">ptype</span><span class="p">,</span>
                        <span class="n">ylimit</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;ylimit&#39;</span><span class="p">],</span> <span class="n">labelsize</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;labelsize&#39;</span><span class="p">],</span>
                        <span class="n">plotname</span><span class="o">=</span><span class="n">resid_name</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">:</span>
                        <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Press ENTER for next image, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                                  <span class="s2">&quot;      &#39;n&#39; to continue without updating header or </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                                  <span class="s2">&quot;      &#39;q&#39; to quit immediately...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
                    <span class="k">if</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;q&#39;</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">quit_immediately</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span></div>


<div class="viewcode-block" id="Image.compute_fit_rms"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.compute_fit_rms">[docs]</a>    <span class="k">def</span> <span class="nf">compute_fit_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># start by interpreting the fit to get the RMS values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identityfit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">goodmatch</span><span class="p">:</span>
            <span class="n">crpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">]</span>
            <span class="n">crval_rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">([</span><span class="n">crpix</span><span class="p">],</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rms_ra</span><span class="p">,</span><span class="n">rms_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">crval_rms</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crval</span><span class="p">)</span>
            <span class="n">nmatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;resids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rms_ra</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rms_dec</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">nmatch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;RMS_RA&#39;</span><span class="p">:</span><span class="n">rms_ra</span><span class="p">,</span><span class="s1">&#39;RMS_DEC&#39;</span><span class="p">:</span><span class="n">rms_dec</span><span class="p">,</span><span class="s1">&#39;NMATCH&#39;</span><span class="p">:</span><span class="n">nmatch</span><span class="p">}</span></div>

<div class="viewcode-block" id="Image.updateHeader"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.updateHeader">[docs]</a>    <span class="k">def</span> <span class="nf">updateHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcsname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reusename</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update header of image with shifts computed by *perform_fit()*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Insure filehandle is open and available...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openFile</span><span class="p">()</span>

        <span class="n">verbose_level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span><span class="p">:</span>
            <span class="n">verbose_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Create WCSCORR table to keep track of WCS revisions anyway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span><span class="p">:</span>
            <span class="n">wcscorr</span><span class="o">.</span><span class="n">init_wcscorr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">)</span>

        <span class="n">extlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wcscorr_extname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span> <span class="o">==</span> <span class="s2">&quot;PRIMARY&quot;</span><span class="p">:</span>
            <span class="n">extlist</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">extlist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span><span class="p">,</span><span class="n">ext</span><span class="p">))</span>
                <span class="c1"># add WCSNAME to SCI headers, if not provided (such as for</span>
                <span class="c1"># drizzled images directly obtained from the archive pre-AD)</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;wcsname&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span><span class="p">,</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="o">.</span><span class="n">fileinfo</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;filemode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;update&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span><span class="p">,</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;wcsname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Default&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">identityfit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">goodmatch</span> <span class="ow">and</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">:</span>
            <span class="n">updatehdr</span><span class="o">.</span><span class="n">updatewcs_with_shift</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span><span class="p">,</span>
                <span class="n">wcsname</span><span class="o">=</span><span class="n">wcsname</span><span class="p">,</span> <span class="n">reusename</span><span class="o">=</span><span class="n">reusename</span><span class="p">,</span>
                <span class="n">fitgeom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_pars</span><span class="p">[</span><span class="s1">&#39;fitgeometry&#39;</span><span class="p">],</span>
                <span class="n">xsh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">ysh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">rot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">],</span><span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">fit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_matrix&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_level</span><span class="p">,</span>
                <span class="n">xrms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">][</span><span class="s1">&#39;RMS_RA&#39;</span><span class="p">],</span>
                <span class="n">yrms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">][</span><span class="s1">&#39;RMS_DEC&#39;</span><span class="p">])</span>

            <span class="n">wnames</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">wcsnames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">altkeys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">wnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wnames</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">wcsname</span><span class="p">:</span>
                    <span class="n">altkeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">altkeys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">altkeys</span><span class="p">:</span>
                <span class="n">altkeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">altkeys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">next_key</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">next_key</span> <span class="o">=</span> <span class="n">altkeys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    Writing out new WCS to alternate WCS: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="n">next_key</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">next_key</span> <span class="o">=</span> <span class="n">next_key</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#if self.identityfit or not self.goodmatch:</span>
            <span class="k">if</span> <span class="n">reusename</span><span class="p">:</span>
                <span class="c1"># Look for key of WCS with this name</span>
                <span class="n">next_key</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">getKeyFromName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span><span class="n">wcsname</span><span class="p">)</span>
                <span class="c1"># This wcsname is new, so start fresh</span>
                <span class="k">if</span> <span class="n">next_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">next_key</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">next_wcskey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Find key for next WCS and save again to replicate an updated solution</span>
                <span class="n">next_key</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">next_wcskey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span><span class="p">:</span>
                <span class="c1"># archive current WCS as alternate WCS with specified WCSNAME</span>
                <span class="c1"># Start by archiving original PRIMARY WCS</span>
                <span class="n">wnames</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">wcsnames</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Define a default WCSNAME in the case that the file to be</span>
                <span class="c1"># updated did not have the WCSNAME keyword defined already</span>
                <span class="c1"># (as will happen when updating images that have not been</span>
                <span class="c1">#  updated using updatewcs).</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wnames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pri_wcsname</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Safeguard against headers not having WCSNAME defined</span>
                    <span class="c1"># This would occur if they were written out by something</span>
                    <span class="c1"># other than stwcs.updatewcs v</span>
                    <span class="k">if</span> <span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wnames</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;wscname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">wnames</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">pri_wcsname</span> <span class="o">=</span> <span class="n">wnames</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">]</span>

                <span class="n">next_pkey</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">getKeyFromName</span><span class="p">(</span><span class="n">fits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="n">pri_wcsname</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;    Saving Primary WCS to alternate WCS: &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="n">next_pkey</span><span class="p">)</span>

                <span class="n">altwcs</span><span class="o">.</span><span class="n">archiveWCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">extlist</span><span class="p">,</span>
                                    <span class="n">wcskey</span><span class="o">=</span><span class="n">next_pkey</span><span class="p">,</span> <span class="n">wcsname</span><span class="o">=</span><span class="n">pri_wcsname</span><span class="p">,</span>
                                    <span class="n">reusekey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reusename</span><span class="p">:</span>
                    <span class="c1"># Look for key of WCS with this name</span>
                    <span class="n">next_key</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">getKeyFromName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span><span class="n">wcsname</span><span class="p">)</span>
                    <span class="c1"># This wcsname is new, so start fresh</span>
                    <span class="k">if</span> <span class="n">next_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">next_key</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">next_wcskey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Find key for next WCS and save again to replicate an updated solution</span>
                    <span class="n">next_key</span> <span class="o">=</span> <span class="n">altwcs</span><span class="o">.</span><span class="n">next_wcskey</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">extlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                    <span class="c1"># update WCSNAME to be the new name</span>
                    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extlist</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;WCSNAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcsname</span>

                <span class="c1"># save again using new WCSNAME</span>
                <span class="n">altwcs</span><span class="o">.</span><span class="n">archiveWCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">extlist</span><span class="p">,</span>
                    <span class="n">wcskey</span><span class="o">=</span><span class="n">next_key</span><span class="p">,</span><span class="n">wcsname</span><span class="o">=</span><span class="n">wcsname</span><span class="p">,</span> <span class="n">reusekey</span><span class="o">=</span><span class="n">reusename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_key</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

        <span class="c1"># add FIT values to image&#39;s PRIMARY header</span>
        <span class="n">fimg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span>

        <span class="k">if</span> <span class="n">wcsname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;INDEF&quot;</span><span class="p">]:</span>
            <span class="n">wcsname</span> <span class="o">=</span> <span class="s1">&#39;TWEAK&#39;</span>
        <span class="c1"># Record values for the fit with both the PRIMARY WCS being updated</span>
        <span class="c1"># and the alternate WCS which will be created.</span>
        <span class="k">assert</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">extlist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FITNAME&#39;</span><span class="o">+</span><span class="n">next_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">wcsname</span>
            <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">kw</span><span class="o">+</span><span class="n">next_key</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">][</span><span class="n">kw</span><span class="p">],</span>
                                     <span class="n">after</span><span class="o">=</span><span class="s1">&#39;FITNAME&#39;</span><span class="o">+</span><span class="n">next_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">perform_update</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating WCSCORR table with new WCS solution &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="o">%</span><span class="n">wcsname</span><span class="p">)</span>
            <span class="n">wcscorr</span><span class="o">.</span><span class="n">update_wcscorr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">wcs_id</span><span class="o">=</span><span class="n">wcsname</span><span class="p">,</span>
                                   <span class="n">extname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ext_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="Image.writeHeaderlet"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.writeHeaderlet">[docs]</a>    <span class="k">def</span> <span class="nf">writeHeaderlet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write and/or attach a headerlet based on update to PRIMARY WCS</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Insure filehandle is open and available...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openFile</span><span class="p">()</span>

        <span class="n">pars</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rms_pars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms_keys&#39;</span><span class="p">]</span>

        <span class="n">str_kw</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;descrip&#39;</span><span class="p">,</span><span class="s1">&#39;history&#39;</span><span class="p">,</span><span class="s1">&#39;author&#39;</span><span class="p">,</span><span class="s1">&#39;hdrfile&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">kw</span> <span class="ow">in</span> <span class="n">str_kw</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="n">pars</span><span class="p">[</span><span class="n">kw</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Call function with properly interpreted input parameters</span>
        <span class="c1"># Syntax: write_headerlet(filename, hdrname, output, sciext=&#39;SCI&#39;,</span>
        <span class="c1">#                    wcsname=None, wcskey=None, destim=None,</span>
        <span class="c1">#                    sipname=None, npolfile=None, d2imfile=None,</span>
        <span class="c1">#                    author=None, descrip=None, history=None,</span>
        <span class="c1">#                    rms_ra=None, rms_dec=None, nmatch=None, catalog=None,</span>
        <span class="c1">#                    attach=True, clobber=False):</span>
        <span class="n">headerlet</span><span class="o">.</span><span class="n">write_headerlet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_im</span><span class="o">.</span><span class="n">hdu</span><span class="p">,</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hdrname&#39;</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hdrfile&#39;</span><span class="p">],</span>
                <span class="n">wcsname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wcskey</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">next_key</span><span class="p">,</span> <span class="n">destim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sipname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npolfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">d2imfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">author</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">],</span> <span class="n">descrip</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;descrip&#39;</span><span class="p">],</span>
                <span class="n">history</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">],</span>
                <span class="n">nmatch</span><span class="o">=</span><span class="n">rms_pars</span><span class="p">[</span><span class="s1">&#39;NMATCH&#39;</span><span class="p">],</span><span class="n">catalog</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;catalog&#39;</span><span class="p">],</span>
                <span class="n">attach</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;attach&#39;</span><span class="p">],</span> <span class="n">clobber</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;clobber&#39;</span><span class="p">]</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Image.write_skycatalog"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.write_skycatalog">[docs]</a>    <span class="k">def</span> <span class="nf">write_skycatalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write out the all_radec catalog for this image to a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">ralist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#.tolist()</span>
        <span class="n">declist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="c1">#.tolist()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#Sky positions for: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#RA        Dec</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#(deg)     (deg)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ralist</span><span class="p">)):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.12f</span><span class="s1">  </span><span class="si">%0.12f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">ralist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">declist</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Image.get_xy_catnames"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.get_xy_catnames">[docs]</a>    <span class="k">def</span> <span class="nf">get_xy_catnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a string with the names of input_xy catalog names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">catstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;  &#39;</span>
        <span class="k">if</span> <span class="s1">&#39;input_xy&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">xycat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;input_xy&#39;</span><span class="p">]:</span>
                <span class="n">catstr</span> <span class="o">+=</span> <span class="s1">&#39;  &#39;</span><span class="o">+</span><span class="n">xycat</span>
        <span class="k">return</span> <span class="n">catstr</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="Image.write_fit_catalog"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.write_fit_catalog">[docs]</a>    <span class="k">def</span> <span class="nf">write_fit_catalog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write out the catalog of all sources and resids used in the final fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;writecat&#39;</span><span class="p">]:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating catalog for the fit: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;fitmatch&#39;</span><span class="p">])</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;fitmatch&#39;</span><span class="p">],</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Input image: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Coordinate mapping parameters: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#    X and Y rms: </span><span class="si">%15.4g</span><span class="s1">  </span><span class="si">%15.4g</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#    X and Y shift: </span><span class="si">%15.4g</span><span class="s1">  </span><span class="si">%15.4g</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#    X and Y scale: </span><span class="si">%15.6g</span><span class="s1">  </span><span class="si">%15.6g</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#    X and Y rotation: </span><span class="si">%15.6g</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# </span><span class="se">\n</span><span class="s1"># Input Coordinate Listing</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 1: X (reference)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 2: Y (reference)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 3: X (input)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 4: Y (input)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 5: X (fit)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 6: Y (fit)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 7: X (residual)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 8: Y (residual)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 9: Original X (reference)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 10: Original Y (reference)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 11: Original X (input)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 12: Original Y (input)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 13: Ref ID</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 14: Input ID</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 15: Input EXTVER ID </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 16: RA (fit)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 17: Dec (fit)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#     Column 18: Ref source provenience</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Need to add chip ID for each matched source to the fitmatch file</span>
            <span class="c1"># The chip information can be extracted from the following source:</span>
            <span class="c1">#</span>
            <span class="c1">#     self.chip_catalogs[sci_extn] = {&#39;catalog&#39;:catalog,&#39;wcs&#39;:wcs}</span>
            <span class="c1">#     xypos = catalog.xypos</span>
            <span class="n">img_chip_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_indx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">sci_extn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nvers</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">sci_extn</span><span class="p">][</span><span class="s1">&#39;catalog&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">catalog</span><span class="o">.</span><span class="n">xypos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">img_indx_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chip_catalogs</span><span class="p">[</span><span class="n">sci_extn</span><span class="p">][</span><span class="s1">&#39;catalog&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">xypos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">chip_min</span> <span class="o">=</span> <span class="n">img_indx_orig</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">chip_max</span> <span class="o">=</span> <span class="n">img_indx_orig</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">cid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">((</span><span class="n">img_chip_id</span> <span class="o">&gt;=</span> <span class="n">chip_min</span><span class="p">),(</span><span class="n">img_chip_id</span> <span class="o">&lt;=</span> <span class="n">chip_max</span><span class="p">))</span>
                    <span class="n">img_chip_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">sci_extn</span><span class="p">,</span> <span class="n">img_chip_id</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">xydata</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;ref_coords&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;ref_coords&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_coords&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_coords&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_xy&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_xy&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;resids&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;resids&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;ref_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;ref_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_orig_xy&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">]],</span>
                      <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;ref_indx&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;img_indx&#39;</span><span class="p">],</span><span class="n">img_chip_id</span><span class="p">],</span>
                      <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_RA&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_DEC&#39;</span><span class="p">]],</span>
                      <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;src_origin&#39;</span><span class="p">]]</span>
                    <span class="p">]</span>

            <span class="n">tweakutils</span><span class="o">.</span><span class="n">write_xy_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="s1">&#39;fitmatch&#39;</span><span class="p">],</span><span class="n">xydata</span><span class="p">,</span>
                <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%15.6f</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%8d</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="si">%20.12f</span><span class="s2">&quot;</span><span class="p">,</span><span class="s2">&quot;   </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="Image.write_outxy"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.write_outxy">[docs]</a>    <span class="k">def</span> <span class="nf">write_outxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write out the output(transformed) XY catalog for this image to a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#Pixel positions for: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#X           Y</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#(pix)       (pix)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">  </span><span class="si">%f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="Image.get_shiftfile_row"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.get_shiftfile_row">[docs]</a>    <span class="k">def</span> <span class="nf">get_shiftfile_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the information for a shiftfile for this image to provide</span>
<span class="sd">            compatability with the IRAF-based MultiDrizzle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rowstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">    </span><span class="si">%0.6f</span><span class="s1">  </span><span class="si">%0.6f</span><span class="s1">    </span><span class="si">%0.6f</span><span class="s1">     </span><span class="si">%0.6f</span><span class="s1">   </span><span class="si">%0.6f</span><span class="s1">  </span><span class="si">%0.6f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rot&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rowstr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">rowstr</span></div>


<div class="viewcode-block" id="Image.clean"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.Image.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove intermediate files created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: add cleaning of mask files, *if* created ...</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;match&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="n">f</span><span class="p">]):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting intermediate match file: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_names</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">extn</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">extn</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Deleting intermediate catalog: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">extn</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">extn</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RefImage"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage">[docs]</a><span class="k">class</span> <span class="nc">RefImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This class provides all the information needed by to define a reference</span>
<span class="sd">        tangent plane and list of source positions on the sky.</span>

<span class="sd">        .. warning::</span>
<span class="sd">          When `wcs_list` is a Python list of `WCS` objects,</span>
<span class="sd">          each element must be an instance of `stwcs.wcsutil.HSTWCS`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcs_list</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span> <span class="n">xycatalog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cat_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">xycatalog</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">if</span> <span class="n">xycatalog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">hdulist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wcs_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Input was a filename for the reference image</span>
            <span class="c1">#froot, fextn = fu.parseFilename(wcs_list)</span>
            <span class="n">fi</span> <span class="o">=</span> <span class="n">parse_cs_line</span><span class="p">(</span><span class="n">wcs_list</span><span class="p">,</span> <span class="n">fnamesOnly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">doNotOpenDQ</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">im_fmode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
            <span class="n">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">release_all_images</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Reference image file name must contain a single &#39;</span>
                           <span class="s1">&#39;file name specification.&#39;</span><span class="p">)</span>
            <span class="n">froot</span> <span class="o">=</span> <span class="n">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">image</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fext</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># there are no &#39;SCI&#39; extensions in the input file -&gt; use</span>
                <span class="c1"># primary HDU:</span>
                <span class="n">fextn</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fextn</span> <span class="o">=</span> <span class="n">fi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># &lt;- we assume that only one</span>
                                      <span class="c1"># extension is specified or that the</span>
                                      <span class="c1"># first one should be used</span>

            <span class="n">hdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">froot</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;readonly&#39;</span><span class="p">,</span> <span class="n">memmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">stwcs</span><span class="o">.</span><span class="n">wcsutil</span><span class="o">.</span><span class="n">HSTWCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">,</span> <span class="n">fextn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_is_wcs_distorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Distorted non-HST reference images &quot;</span>
                                         <span class="s2">&quot;are not supported.&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reference image contains a distorted WCS.</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;Using the undistorted version of this WCS.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">output_wcs</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">],</span> <span class="n">undistort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Unsupported instrument&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">e</span>
                <span class="c1"># try using astropy.wcs:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">pywcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdulist</span><span class="p">[</span><span class="n">fextn</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">hdulist</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">_is_wcs_distorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Distorted non-HST reference images &quot;</span>
                                     <span class="s2">&quot;are not supported.&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hdulist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">hdulist</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">froot</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wcs_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># generate a reference tangent plane from a list of STWCS objects</span>
            <span class="n">undistort</span> <span class="o">=</span> <span class="n">_is_wcs_distorted</span><span class="p">(</span><span class="n">wcs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">undistort</span> <span class="ow">and</span> <span class="n">wcs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Distorted non-HST reference images &quot;</span>
                                 <span class="s2">&quot;are not supported.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">output_wcs</span><span class="p">(</span><span class="n">wcs_list</span><span class="p">,</span> <span class="n">undistort</span><span class="o">=</span><span class="n">undistort</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span> <span class="o">=</span> <span class="n">wcs_functions</span><span class="o">.</span><span class="n">make_perfect_cd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;ref_wcs_name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ref_wcs_name&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">wcs_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">filename</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># only a single WCS provided, so use that as the definition</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">wcs_list</span><span class="p">,</span> <span class="n">stwcs</span><span class="o">.</span><span class="n">wcsutil</span><span class="o">.</span><span class="n">HSTWCS</span><span class="p">):</span>
                 <span class="c1"># User provided full HSTWCS object</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">wcs_list</span>
                <span class="n">froot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">filename</span>
                <span class="k">if</span> <span class="n">_is_wcs_distorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Distorted non-HST reference images &quot;</span>
                                         <span class="s2">&quot;are not supported.&quot;</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reference image contains a distorted WCS.</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="s2">&quot;Using the undistorted version of this WCS.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">output_wcs</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">],</span> <span class="n">undistort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">froot</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unsupported &#39;wcs_list&#39; type.&quot;</span><span class="p">)</span>

        <span class="c1"># assert(not _is_wcs_distorted(self.wcs))</span>
        <span class="k">if</span> <span class="n">_is_wcs_distorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">):</span>
            <span class="n">warnstr</span> <span class="o">=</span> <span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span>
                <span class="s2">&quot;WARNING: Reference image appears to have a distorted WCS. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;This is likely due to a deviation of WCS&#39; CD (or PC) &quot;</span>
                <span class="s2">&quot;matrix from orthogonality. </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Residual distortions in the reference WCS will result &quot;</span>
                <span class="s2">&quot;in sub-optimal image alignment.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Check orthogonality of the CD (or PC) matrix!&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">warnstr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">warnstr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;use_sharp_round&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;use_sharp_round&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># See if computation of the bounding polygon for</span>
        <span class="c1"># the reference catalog was requested:</span>
        <span class="n">find_bounding_polygon</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;find_bounding_polygon&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Interpret the provided catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">catalogs</span><span class="o">.</span><span class="n">RefCatalog</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">catalog</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">buildCatalogs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">radec</span>
        <span class="n">nradec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nradec_col</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nradec_col</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nradec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nradec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">nradec_col</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">nradec_col</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nradec</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">nradec_col</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># add input source positions to RefCatalog for reporting in final</span>
        <span class="c1"># matched output catalog files</span>
        <span class="k">if</span> <span class="n">xycatalog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xypostypes</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">+</span> \
                <span class="p">(</span><span class="mi">3</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">object</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span><span class="p">,</span><span class="n">cat</span> <span class="ow">in</span> \
                               <span class="nb">zip</span><span class="p">(</span><span class="n">xypostypes</span><span class="p">,</span><span class="n">xycatalog</span><span class="p">)]</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">)</span>
            <span class="n">nobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">nradec</span> <span class="o">==</span> <span class="n">nobj</span><span class="p">)</span>

            <span class="k">assert</span><span class="p">(</span><span class="n">ncol</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ncol</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># account for flux column</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                <span class="n">ncol</span> <span class="o">=</span> <span class="mi">3</span>

            <span class="k">if</span> <span class="n">ncol</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1"># add source ID column</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nobj</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">start_id</span><span class="p">)</span>
                <span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span><span class="p">:</span>
                <span class="c1"># if necessary, add sharpness and roundness columns:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncol</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert RA/Dec positions of source from refimage into</span>
            <span class="c1"># X,Y positions based on WCS of refimage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="s1">&#39;refxyunits&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;refxyunits&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pixels&#39;</span><span class="p">:</span>
                <span class="n">xypos</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xypos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">nobj</span> <span class="o">=</span> <span class="n">xypos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">nradec</span> <span class="o">==</span> <span class="n">nobj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xypos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xypos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>
                <span class="n">ncol</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ncol</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="c1"># add source provenience (origin)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="ow">and</span> <span class="n">ncol</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span> <span class="ow">and</span> <span class="n">ncol</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cat_origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nobj</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                                                  <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_origin</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nobj</span><span class="o">*</span><span class="p">[</span><span class="n">cat_origin</span><span class="p">],</span>
                                                      <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_origin</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> \
                     <span class="nb">isinstance</span><span class="p">(</span><span class="n">cat_origin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cat_origin</span><span class="p">,</span>
                                                      <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
                    <span class="n">orig_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cat_origin</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">orig_len</span> <span class="o">&lt;</span> <span class="n">nobj</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nobj</span><span class="o">*</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Parameter &#39;cat_origin&#39; must be &quot;</span>
                        <span class="s2">&quot;a string, a list, or a numpy.ndarray&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># convert sky positions to X,Y positions on reference tangent plane</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformToRef</span><span class="p">()</span>

        <span class="c1"># Compute bounding convex hull for the reference catalog:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">find_bounding_polygon</span> <span class="ow">or</span> <span class="n">IMAGE_USE_CONVEX_HULL</span><span class="p">)</span> <span class="ow">and</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xy_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">convex_hull</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="p">))),</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xy_vertices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">rdv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">xy_vertices</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skyline</span> <span class="o">=</span> <span class="n">SphericalPolygon</span><span class="o">.</span><span class="n">from_radec</span><span class="p">(</span><span class="n">rdv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rdv</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skyline</span> <span class="o">=</span> <span class="n">SphericalPolygon</span><span class="p">([])</span>

            <span class="k">if</span> <span class="n">IMGCLASSES_DEBUG</span><span class="p">:</span>
                <span class="n">_debug_write_region_fk5</span><span class="p">(</span><span class="s1">&#39;dbg_tweakreg_refcat_bounding_polygon.reg&#39;</span><span class="p">,</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">rdv</span><span class="o">.</span><span class="n">transpose</span><span class="p">())),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">)),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyline</span> <span class="o">=</span> <span class="n">SphericalPolygon</span><span class="p">([])</span>


<div class="viewcode-block" id="RefImage.clear_dirty_flag"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.clear_dirty_flag">[docs]</a>    <span class="k">def</span> <span class="nf">clear_dirty_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="RefImage.set_dirty"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.set_dirty">[docs]</a>    <span class="k">def</span> <span class="nf">set_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="RefImage.write_skycatalog"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.write_skycatalog">[docs]</a>    <span class="k">def</span> <span class="nf">write_skycatalog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">show_flux</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_id</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write out the all_radec catalog for this image to a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#Sky positions for cumulative reference catalog. Initial catalog from: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">header1</span> <span class="o">=</span> <span class="s2">&quot;#RA        Dec&quot;</span>
        <span class="n">header2</span> <span class="o">=</span> <span class="s2">&quot;#(deg)     (deg)&quot;</span>
        <span class="k">if</span> <span class="n">show_flux</span><span class="p">:</span>
            <span class="n">header1</span> <span class="o">+=</span> <span class="s2">&quot;        Flux&quot;</span>
            <span class="n">header2</span> <span class="o">+=</span> <span class="s2">&quot;       (counts)&quot;</span>
        <span class="k">if</span> <span class="n">show_id</span><span class="p">:</span>
            <span class="n">header1</span> <span class="o">+=</span> <span class="s2">&quot;        ID        Origin&quot;</span>
            <span class="n">header2</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">header1</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">header2</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header1</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header2</span><span class="p">)</span>

        <span class="n">show_details</span> <span class="o">=</span> <span class="n">show_flux</span> <span class="ow">or</span> <span class="n">show_id</span>
        <span class="n">flux_end_char</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">show_details</span> <span class="ow">and</span> <span class="n">show_flux</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">show_id</span><span class="p">:</span>
                <span class="n">flux_end_char</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">src_line</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:.7f}</span><span class="s2">  </span><span class="si">{:.7f}</span><span class="s2">&quot;</span> \
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">show_details</span><span class="p">:</span>
                <span class="c1">#src_line += &quot; #&quot;</span>
                <span class="k">if</span> <span class="n">show_flux</span><span class="p">:</span>
                    <span class="c1">#src_line += &quot; flux: {:.5g}{:s}&quot; \</span>
                        <span class="c1">#.format(self.xy_catalog[2][i], flux_end_char)</span>
                    <span class="n">src_line</span> <span class="o">+=</span> <span class="s2">&quot;  </span><span class="si">{:.5g}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">show_id</span><span class="p">:</span>
                    <span class="c1">#src_line += &quot; ID: {:d}\torigin: &#39;{:s}&#39;&quot; \</span>
                        <span class="c1">#.format(self.xy_catalog[3][i], self.xy_catalog[-1][i])</span>
                    <span class="n">src_line</span> <span class="o">+=</span> <span class="s2">&quot;  </span><span class="si">{:d}</span><span class="s2">  </span><span class="si">{:s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">src_line</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="RefImage.transformToRef"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.transformToRef">[docs]</a>    <span class="k">def</span> <span class="nf">transformToRef</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Transform reference catalog sky positions (self.all_radec)</span>
<span class="sd">        to reference tangent plane (self.wcs) to create output X,Y positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;refxyunits&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;refxyunits&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pixels&#39;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Creating RA/Dec positions for reference sources...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span>
            <span class="n">skypos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">skypos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">skypos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Converting RA/Dec positions of reference sources from &quot;</span><span class="si">%s</span><span class="s1">&quot; to &#39;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span>
                        <span class="s1">&#39;X,Y positions in reference WCS...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refWCS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span>
            <span class="n">outxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_world2pix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="c1"># convert outxy list to a Nx2 array</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">outxy</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">outxy</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]])</span></div>


<div class="viewcode-block" id="RefImage.append_not_matched_sources"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.append_not_matched_sources">[docs]</a>    <span class="k">def</span> <span class="nf">append_not_matched_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="s1">&#39;matches&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">goodmatch</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">identityfit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">matched_idx</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">matches</span><span class="p">[</span><span class="s1">&#39;input_idx&#39;</span><span class="p">]</span>

        <span class="c1"># append new sources to the reference catalog:</span>
        <span class="n">old_ref_nsources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">adding_nsources</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">outxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">matched_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">adding_nsources</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">{}</span><span class="s2"> new sources to the reference catalog &quot;</span>
              <span class="s2">&quot;for a total of </span><span class="si">{}</span><span class="s2"> sources.&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">adding_nsources</span><span class="p">,</span> <span class="n">old_ref_nsources</span> <span class="o">+</span> <span class="n">adding_nsources</span><span class="p">))</span>
        <span class="n">not_matched_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">outxy</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="n">not_matched_mask</span><span class="p">[</span><span class="n">matched_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">not_matched_outxy</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">outxy</span><span class="p">[</span><span class="n">not_matched_mask</span><span class="p">]</span>

        <span class="c1"># apply corrections based on the fit:</span>
        <span class="n">new_outxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">not_matched_outxy</span><span class="o">-</span><span class="n">image</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span><span class="p">,</span>
                           <span class="n">image</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="s1">&#39;fit_matrix&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span>

        <span class="c1"># convert to RA &amp; DEC:</span>
        <span class="n">new_radec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">new_outxy</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="p">,</span> <span class="n">new_outxy</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">id1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">id2</span> <span class="o">=</span> <span class="n">id1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_radec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_radec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">image</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">not_matched_mask</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span><span class="n">id2</span><span class="p">),</span> <span class="mi">0</span><span class="p">)]</span>

        <span class="c1"># Append original image coordinates:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="n">not_matched_mask</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">not_matched_mask</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ncol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_sharp_round</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="n">ncol</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="n">i2</span><span class="p">],</span> <span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="n">not_matched_mask</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1">#self.skyline = self.skyline.union(skyline)</span>
        <span class="n">xy_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">convex_hull</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outxy</span><span class="p">))),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">rdv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">xy_vertices</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyline</span> <span class="o">=</span> <span class="n">SphericalPolygon</span><span class="o">.</span><span class="n">from_radec</span><span class="p">(</span><span class="n">rdv</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">rdv</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">IMGCLASSES_DEBUG</span><span class="p">:</span>
            <span class="n">_debug_write_region_fk5</span><span class="p">(</span><span class="s1">&#39;dbg_tweakreg_refcat_bounding_polygon.reg&#39;</span><span class="p">,</span>
                                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">rdv</span><span class="o">.</span><span class="n">transpose</span><span class="p">())),</span>
                                    <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">all_radec</span><span class="p">)),</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">xy_catalog</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_dirty</span><span class="p">()</span></div>


<div class="viewcode-block" id="RefImage.get_shiftfile_row"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.get_shiftfile_row">[docs]</a>    <span class="k">def</span> <span class="nf">get_shiftfile_row</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the information for a shiftfile for this image to provide</span>
<span class="sd">            compatability with the IRAF-based MultiDrizzle.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rowstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">    0.0  0.0    0.0     1.0    0.0 0.0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rowstr</span></div>


<div class="viewcode-block" id="RefImage.clean"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove intermediate files created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_blank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catname</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">catname</span><span class="p">)</span></div>


<div class="viewcode-block" id="RefImage.close"><a class="viewcode-back" href="../../image.html#drizzlepac.imgclasses.RefImage.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div></div>


<span class="k">def</span> <span class="nf">build_referenceWCS</span><span class="p">(</span><span class="n">catalog_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Compute default reference WCS from list of Catalog objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wcslist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">catalog</span> <span class="ow">in</span> <span class="n">catalog_list</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">scichip</span> <span class="ow">in</span> <span class="n">catalog</span><span class="o">.</span><span class="n">catalogs</span><span class="p">:</span>
            <span class="n">wcslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catalog</span><span class="o">.</span><span class="n">catalogs</span><span class="p">[</span><span class="n">scichip</span><span class="p">][</span><span class="s1">&#39;wcs&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">utils</span><span class="o">.</span><span class="n">output_wcs</span><span class="p">(</span><span class="n">wcslist</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">verify_hdrname</span><span class="p">(</span><span class="o">**</span><span class="n">pars</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;headerlet&#39;</span><span class="p">]:</span>
        <span class="k">return</span>

    <span class="c1"># Insure a valid value for hdrname</span>
    <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">is_blank</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hdrname&#39;</span><span class="p">])</span> <span class="ow">and</span> \
        <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">is_blank</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wcsname&#39;</span><span class="p">]):</span>
            <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hdrname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;wcsname&#39;</span><span class="p">]</span>

    <span class="c1"># interpret input strings</span>
    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s1">&#39;hdrname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">warnstr</span> <span class="o">=</span> <span class="s1">&#39;WARNING:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">warnstr</span> <span class="o">+=</span> <span class="s1">&#39;    Headerlet generation requested, but </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">warnstr</span> <span class="o">+=</span> <span class="s1">&#39;    no valid &quot;hdrname&quot; parameter value was provided!</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">warnstr</span> <span class="o">+=</span> <span class="s1">&#39;    The requested headerlets can NOT be generated! </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">warnstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">warnstr</span> <span class="o">+=</span> <span class="s1">&#39;    Please provide valid &quot;hdrname&quot; or &quot;wcsname&quot; value </span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">warnstr</span> <span class="o">+=</span> <span class="s1">&#39;        in your next run to write out headerlets.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">textutil</span><span class="o">.</span><span class="n">textbox</span><span class="p">(</span><span class="n">warnstr</span><span class="p">))</span>
        <span class="k">return</span>


<span class="k">def</span> <span class="nf">_debug_write_region_fk5</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">ivert</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">src_origin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">append</span><span class="p">:</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Region file format: DS9 version 4.1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;global color=green dashlist=8 3 width=2 font=&quot;helvetica 10 normal roman&quot; select=1 highlite=1 dash=0 fixed=0 edit=1 move=1 delete=1 include=1 source=1</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;fk5</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;polygon(</span><span class="si">{}</span><span class="s1">) # color=red width=2</span><span class="se">\n</span><span class="s1">&#39;</span>
             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,[</span><span class="n">x</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ivert</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">e</span><span class="p">]))))</span>
    <span class="k">if</span> <span class="n">src_origin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;point(</span><span class="si">{}</span><span class="s1">) # point=x</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">orig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">src_origin</span><span class="p">):</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;point(</span><span class="si">{}</span><span class="s1">) # point=x text={{</span><span class="si">{}</span><span class="s1">}}</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">]])),</span> <span class="n">orig</span><span class="p">))</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">convex_hull</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the convex hull of a set of 2D points.</span>

<span class="sd">    Implements `Andrew&#39;s monotone chain algorithm &lt;http://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain&gt;`_.</span>
<span class="sd">    The algorithm has O(n log n) complexity.</span>

<span class="sd">    Credit: `&lt;http://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain&gt;`_</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    points : list of tuples</span>
<span class="sd">        An iterable sequence of (x, y) pairs representing the points.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Output : list</span>
<span class="sd">        A list of vertices of the convex hull in counter-clockwise order,</span>
<span class="sd">        starting from the vertex with the lexicographically smallest</span>
<span class="sd">        coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Sort the points lexicographically (tuples are compared lexicographically).</span>
    <span class="c1"># Remove duplicates to detect the case we have just one unique point.</span>
    <span class="n">points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">points</span><span class="p">))</span>

    <span class="c1"># Boring case: no points or a single point, possibly repeated multiple times.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">points</span>

    <span class="c1"># 2D cross product of OA and OB vectors, i.e. z-component of their 3D cross product.</span>
    <span class="c1"># Returns a positive value, if OAB makes a counter-clockwise turn,</span>
    <span class="c1"># negative for clockwise turn, and zero if the points are collinear.</span>
    <span class="k">def</span> <span class="nf">cross</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">o</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">o</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Build lower hull</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">cross</span><span class="p">(</span><span class="n">lower</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">lower</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lower</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">lower</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># Build upper hull</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">cross</span><span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">upper</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">upper</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">upper</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c1"># Concatenation of the lower and upper hulls gives the convex hull.</span>
    <span class="c1"># Last point of each list is omitted because it is repeated at the beginning of the other list.</span>
    <span class="k">return</span> <span class="n">lower</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">upper</span>


<span class="k">def</span> <span class="nf">_is_wcs_distorted</span><span class="p">(</span><span class="n">wcs</span><span class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_is_cd_unitary</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">wcs</span><span class="o">.</span><span class="n">sip</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="n">wcs</span><span class="o">.</span><span class="n">cpdis1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wcs</span><span class="o">.</span><span class="n">cpdis2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> \
                <span class="n">wcs</span><span class="o">.</span><span class="n">det2im1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">wcs</span><span class="o">.</span><span class="n">det2im2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_cd_unitary</span><span class="p">(</span><span class="n">wcs</span><span class="p">):</span>
    <span class="c1"># set maximum acceptable deviation of matrix elements from zero -</span>
    <span class="c1"># a measure of closeness to matrix being unitary:</span>
    <span class="n">maxerr</span> <span class="o">=</span> <span class="mf">50.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>

    <span class="n">cd</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="s1">&#39;cd&#39;</span><span class="p">):</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cd</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="s1">&#39;pc&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="p">,</span> <span class="s1">&#39;cdelt&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent WCS specification (missing CDELT &quot;</span>
                             <span class="s2">&quot;with a valid PC).&quot;</span><span class="p">)</span>
        <span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">),</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pc</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">pixarea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cd</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pixarea</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Singular CD (or PC &amp; CDELT) matrix.&quot;</span><span class="p">)</span>

    <span class="c1"># NOTE: Technically, below we should use np.dot(cd, np.conjugate(cd.T))</span>
    <span class="c1"># However, I am not aware of complex CD/PC matrices...</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="n">cd</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixarea</span>
    <span class="n">cd_unitary_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">I</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="c1"># or, use RMS instead of max error:</span>
    <span class="c1">#cd_unitary_err = np.sqrt(np.mean(np.abs(I-np.eye(shape[0]))**2))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">cd_unitary_err</span> <span class="o">&lt;</span> <span class="n">maxerr</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">DrizzlePac 2.1.15 (26-May-2017) documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Warren Hack, Nadia Dencheva, Chris Sontag, Megan Sosey, Michael Droettboom, Mihai Cara.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.
    </div>
  </body>
</html>